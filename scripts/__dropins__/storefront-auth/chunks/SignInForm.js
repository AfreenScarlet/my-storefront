/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as m,jsxs as S}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as Z,classes as z}from"@dropins/tools/lib.js";import{c as _,g as R,u as tt,F as rt,B as H}from"./UpdatePasswordForm.js";import{useState as g,useCallback as d,useEffect as $,useMemo as at}from"@dropins/tools/preact-hooks.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/recaptcha.js";import{a as et}from"./getCustomerToken.js";import{r as ot}from"./resendConfirmationEmail.js";import{s as it,a as st}from"./simplifyTransformAttributesForm.js";import{f as nt,E as ut}from"./EmailConfirmationForm.js";import{c as mt}from"./confirmEmail.js";import{useText as J}from"@dropins/tools/i18n.js";import{Header as ct,InLineAlert as ft,InputPassword as dt}from"@dropins/tools/components.js";/* empty css                       */const lt=({emailConfirmationStatusMessage:t,translations:e,initialEmailValue:s,routeSignUp:l,routeForgotPassword:u,routeRedirectOnSignIn:E,onErrorCallback:w,setActiveComponent:a,onSuccessCallback:c,onSignUpLinkClick:h,handleSetInLineAlertProps:i,routeRedirectOnEmailConfirmationClose:x})=>{const[L,B]=g(""),[v,n]=g(!1),[F,f]=g(""),[A,y]=g(!1),[U,j]=g({userName:"",status:!1}),[q,T]=g(!1),[k,N]=g([]),P=d(async r=>{i(),n(!0),y(!1),N([]),await ot(r)},[i]),V=d(r=>{r.length?y(!1):y(!0),f(r)},[]);$(()=>{t!=null&&t.text&&i({text:t.text,type:t.status?t.status:void 0})},[t,i]);const p=d((r,o)=>F.length?!1:(y(!0),o&&nt(r,F,""),!0),[F]),C=d((r,o)=>{o!=null&&o.userName&&(r.target.reset(),_(E)?window.location.href=E():(c==null||c({userName:o==null?void 0:o.userName,status:!0}),j({userName:o==null?void 0:o.userName,status:!0})))},[c,E]),M=d((r,o)=>{var I;if((I=r==null?void 0:r.errorMessage)!=null&&I.length){B(o);const G=r.errorMessage.includes("This account isn't confirmed. Verify and try again."),b=G?e.resendEmailInformationText:r.errorMessage;N(G?[{label:e.resendEmailButtonText,onClick:()=>{P(o)}}]:[]),i({text:b,type:"error"}),f("")}},[P,i,e.resendEmailButtonText,e.resendEmailInformationText]),D=d(async(r,o)=>{if(i(),p(r,o))return;T(!0);const I=R(r.target);if(Object.values(I).every(b=>b)){const{email:b,password:Y}=I,K=await et({email:b,password:Y,handleSetInLineAlertProps:i,onErrorCallback:w,translations:e});M(K,b),C(r,K),y(!1)}T(!1)},[e,w,p,M,C,i]),O=d(()=>{if(_(a)){a("resetPasswordForm");return}_(u)&&(window.location.href=u())},[u,a]),Q=d(()=>{if(_(h)&&h(),_(a)){a("signUpForm");return}_(l)&&(window.location.href=l())},[h,l,a]),W=at(()=>{const r=it(st);return s!=null&&s.length?r==null?void 0:r.map(o=>({...o,defaultValue:s})):r},[s]),X=d(()=>{i(),_(x)?window.location.href=x():n(!1)},[i,x]);return{additionalActionsAlert:k,userEmail:L,defaultEnhancedEmailFields:W,passwordError:A,isSuccessful:U,isLoading:q,signInPasswordValue:F,showEmailConfirmationForm:v,setShowEmailConfirmationForm:n,setSignInPasswordValue:f,submitLogInUser:D,forgotPasswordCallback:O,onSignUpLinkClickCallback:Q,handledOnPrimaryButtonClick:X,handleSetPassword:V}},ht=()=>{let t=new URL(window.location.href),e=t.searchParams.get("email"),s=t.searchParams.get("key");e&&s&&(t.searchParams.delete("email"),t.searchParams.delete("key"),window.history.replaceState({},document.title,t.toString()))},gt=({enableEmailConfirmation:t})=>{const e=J({accountConfirmMessage:"Auth.EmailConfirmationForm.accountConfirmMessage",accountConfirmationEmailSuccessMessage:"Auth.EmailConfirmationForm.accountConfirmationEmailSuccessMessage"}),[s,l]=g({text:"",status:""});return $(()=>{if(t){const{search:u}=window.location;u.includes("email=")&&u.includes("key=")&&(async()=>{var c,h,i;const w=new URLSearchParams(u),a=await mt({customerEmail:w.get("email"),customerConfirmationKey:w.get("key")});if(!a)return null;(c=a==null?void 0:a.errors)!=null&&c.length?l({text:a==null?void 0:a.errors[0].message,status:"error"}):(l({text:a.data.confirmEmail.customer.email?e.accountConfirmationEmailSuccessMessage.replace("{email}",(i=(h=a==null?void 0:a.data)==null?void 0:h.confirmEmail.customer)==null?void 0:i.email):e.accountConfirmMessage,status:"success"}),ht())})()}},[t,e]),{emailConfirmationStatusMessage:s}},Ct=({slots:t,labels:e,formSize:s="default",initialEmailValue:l="",renderSignUpLink:u=!1,enableEmailConfirmation:E=!1,hideCloseBtnOnEmailConfirmation:w=!1,routeRedirectOnEmailConfirmationClose:a,routeRedirectOnSignIn:c,routeForgotPassword:h,routeSignUp:i,onSuccessCallback:x,setActiveComponent:L,onErrorCallback:B,onSignUpLinkClick:v})=>{const n=J({title:"Auth.SignInForm.title",buttonPrimary:"Auth.SignInForm.buttonPrimary",buttonSecondary:"Auth.SignInForm.buttonSecondary",buttonTertiary:"Auth.SignInForm.buttonTertiary",resendEmailInformationText:"Auth.Notification.resendEmailNotification.informationText",resendEmailButtonText:"Auth.Notification.resendEmailNotification.buttonText",customerTokenErrorMessage:"Auth.Api.customerTokenErrorMessage",placeholder:"Auth.InputPassword.placeholder",floatingLabel:"Auth.InputPassword.floatingLabel",requiredFieldError:"Auth.FormText.requiredFieldError"}),{emailConfirmationStatusMessage:F}=gt({enableEmailConfirmation:E}),{inLineAlertProps:f,handleSetInLineAlertProps:A}=tt(),{userEmail:y,additionalActionsAlert:U,defaultEnhancedEmailFields:j,passwordError:q,isSuccessful:T,isLoading:k,signInPasswordValue:N,showEmailConfirmationForm:P,submitLogInUser:V,forgotPasswordCallback:p,onSignUpLinkClickCallback:C,handledOnPrimaryButtonClick:M,handleSetPassword:D}=lt({translations:n,emailConfirmationStatusMessage:F,initialEmailValue:l,routeSignUp:i,routeForgotPassword:h,routeRedirectOnSignIn:c,setActiveComponent:L,onErrorCallback:B,onSuccessCallback:x,onSignUpLinkClick:v,handleSetInLineAlertProps:A,routeRedirectOnEmailConfirmationClose:a});return T.status&&(t!=null&&t.SuccessNotification)?m(Z,{"data-testid":"successNotificationTestId",name:"SuccessNotification",slot:t==null?void 0:t.SuccessNotification,context:{isSuccessful:T}}):P?m(ut,{formSize:s,userEmail:y,inLineAlertProps:f,hideCloseBtnOnEmailConfirmation:w,handleSetInLineAlertProps:A,onPrimaryButtonClick:M}):S("div",{className:z(["auth-sign-in-form",`auth-sign-in-form--${s}`]),"data-testid":"signInForm",children:[m(ct,{title:(e==null?void 0:e.formTitleText)??n.title,divider:!1,className:"auth-sign-in-form__title"}),f.text?m(ft,{"data-testid":"authInLineAlert",className:"auth-sign-in-form__notification",type:f.type,variant:"secondary",heading:f.text,icon:f.icon,additionalActions:U}):null,S(rt,{name:"signIn_form",className:"auth-sign-in-form__form",onSubmit:V,loading:k,fieldsConfig:j,children:[m(dt,{hideStatusIndicator:!0,className:"auth-sign-in-form__form__password",autoComplete:"current-password",errorMessage:q?n.requiredFieldError:void 0,defaultValue:N,onValue:D,placeholder:n.placeholder,floatingLabel:n.floatingLabel}),S("div",{className:"auth-sign-in-form__form__buttons",children:[S("div",{className:"auth-sign-in-form__form__buttons__combine",children:[m(H,{type:"button",variant:"tertiary",style:{padding:0},buttonText:n.buttonTertiary,className:"auth-sign-in-form__button auth-sign-in-form__button--forgot",enableLoader:!1,onClick:p,"data-testid":"switchToSignUp"}),u?m("span",{}):null,u?m(H,{type:"button",variant:"tertiary",style:{padding:0},buttonText:n.buttonSecondary,className:"auth-sign-in-form__button auth-sign-in-form__button--signup",enableLoader:!1,onClick:C}):null]}),m(H,{type:"submit",buttonText:(e==null?void 0:e.primaryButtonText)??n.buttonPrimary,variant:"primary",className:"auth-sign-in-form__button auth-sign-in-form__button--submit",enableLoader:k})]})]}),m("div",{id:"generateCustomerToken"})]})};export{Ct as S};
