/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as m,jsxs as K}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as Ne,classes as ye}from"@dropins/tools/lib.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/recaptcha.js";import{g as Ue,c as Le,a as Me}from"./createCustomerAddress.js";import{useState as p,useEffect as Te,useCallback as L,useMemo as xe}from"@dropins/tools/preact-hooks.js";import{s as de,b as Se}from"./simplifyTransformAttributesForm.js";import{v as Ce,u as ve,a as qe}from"./usePasswordValidationMessage.js";import{a as Ae}from"./getCustomerToken.js";import{p as le,E as fe}from"./getStoreConfig.js";import{c as W,g as Be,u as Ke,F as je,B as he}from"./UpdatePasswordForm.js";import{c as Ie}from"./transform-attributes-form.js";import{f as Ge,E as He}from"./EmailConfirmationForm.js";import{Header as Ve,InLineAlert as We,InputPassword as ge,Field as se,Checkbox as ie}from"@dropins/tools/components.js";/* empty css                       */import{S as $e}from"./SkeletonLoader.js";import{useText as Oe}from"@dropins/tools/i18n.js";const pe=(u,r)=>r!=null&&r.length?u.map(e=>{var c;const t=(c=r.find(({code:n})=>n===e.code))==null?void 0:c.defaultValue;return t?{...e,defaultValue:t}:e}):u,Je=({inputsDefaultValueSet:u,fieldsConfigForApiVersion1:r,apiVersion2:e})=>{const[t,c]=p([]);return Te(()=>{(async()=>{if(e){const i=await Ue("customer_account_create");if(i!=null&&i.length)if(u!=null&&u.length){const F=pe(i,u);c(F)}else c(i)}else{const i=de(Se),F=de(r),E=pe(i,u);c(r&&r.length?F:E)}})()},[e,r,u]),{fieldsListConfigs:t}},Qe=(u,r)=>{const e=["date_of_birth","email","firstname","gender","is_subscribed","lastname","middlename","password","prefix","suffix","taxvat"],t=Ie(u,"snakeCase",{firstName:"firstname",lastName:"lastname"});if(!r)return{...t,...t!=null&&t.gender?{gender:Number(t==null?void 0:t.gender)}:{}};const c={},n=[];return Object.keys(t).forEach(i=>{e.includes(i)?c[i]=i.includes("gender")?Number(t[i]):t[i]:n.push({attribute_code:i,value:t[i]})}),n.length>0&&(c.custom_attributes=n),c},Xe=({requireRetypePassword:u,addressesData:r,translations:e,isEmailConfirmationRequired:t,apiVersion2:c=!0,passwordConfigs:n,isAutoSignInEnabled:i,routeRedirectOnSignIn:F,routeSignIn:E,onErrorCallback:M,onSuccessCallback:h,setActiveComponent:w,handleSetInLineAlertProps:b,routeRedirectOnEmailConfirmationClose:S})=>{const[$,C]=p(!1),[o,a]=p(""),[g,d]=p(""),[j,N]=p(""),[I,v]=p(!1),[O,q]=p({userName:"",status:!1}),[l,A]=p(""),[J,G]=p(!1),[Q,y]=p(!1),[H,X]=p(!0),Y=L(s=>{const f=s.target.value;C(!f.length),f.length&&o.length&&f!==o&&d(e.passwordMismatch)},[o,e.passwordMismatch]),Z=L(s=>{const f=s.target.value;d(f.length?"":e.requiredFieldError),f.length&&l.length&&f!==l&&d(e.passwordMismatch)},[l,e.passwordMismatch,e.requiredFieldError]),k=L(s=>{a(s),d(s?l===s?"":e.passwordMismatch:e.requiredFieldError)},[e,l]),z=L(({target:s})=>{X(s.checked)},[]),D=L(()=>{if(W(w)){w("signInForm");return}W(E)&&(window.location.href=E())},[w,E]),R=L(s=>{A(s),C(!s.length),s===o&&d("")},[o]),ee=L(()=>{b(),A(""),W(S)?window.location.href=S():(v(!1),w==null||w("signInForm"))},[b,S,w]),U=()=>{G(!0),y(!1)},P=()=>{const s=l.length&&o.length,f=l!==o;U(),C(!l.length),o||d(e.requiredFieldError),s&&f&&d(e.passwordMismatch)};return{showPasswordErrorMessage:$,confirmPassword:o,confirmPasswordMessage:g,isKeepMeLogged:H,userEmail:j,showEmailConfirmationForm:I,isSuccessful:O,isClickSubmit:J,signUpPasswordValue:l,isLoading:Q,onSubmitSignUp:async(s,f)=>{var me,ne,ue;if(b(),d(""),y(!0),!f){P();return}if(u&&(g.length||l!==o)){U(),d(o.length?e.passwordMismatch:e.requiredFieldError),Ge(s,l,o);return}const Fe=c?"createCustomerV2":"createCustomer",{confirmPasswordField:Ye,...ae}=Be(s.target),{email:re,password:B,is_subscribed:we}=ae,be=(n==null?void 0:n.requiredCharacterClasses)||0,Pe=(n==null?void 0:n.minLength)||1;if(!Ce(B,be)||Pe>(B==null?void 0:B.length)){U();return}const _e=Qe({...ae,is_subscribed:!!we||!1},c),{data:T,errors:x}=await Le(_e,c),V=((ne=(me=T==null?void 0:T.createCustomer)==null?void 0:me.customer)==null?void 0:ne.firstname)||"";if(x&&(x!=null&&x.length))b==null||b({type:"error",text:x[0].message}),M==null||M(x),le(fe.CREATE_ACCOUNT_EVENT,{updateProfile:!1}),N(re);else{const te={email:"",...T==null?void 0:T[Fe]};if(le(fe.CREATE_ACCOUNT_EVENT,{email:te==null?void 0:te.email,updateProfile:!0}),t||!i){if(h==null||h({userName:V,status:!0}),t){(ue=s.target)==null||ue.reset(),A(""),v(!0),N(re),y(!1);return}if(!i){y(!1),q({userName:V,status:!0});return}}const _=await Ae({email:re,password:B,translations:e,handleSetInLineAlertProps:b,onErrorCallback:M});if(_!=null&&_.userName){if(r!=null&&r.length)for(const ce of r)try{await Me(ce)}catch(Ee){console.error(e.failedCreateCustomerAddress,ce,Ee)}W(F)?window.location.href=F():(h==null||h({userName:_==null?void 0:_.userName,status:!0}),q({userName:_==null?void 0:_.userName,status:!0}))}else h==null||h({userName:V,status:!0}),q({userName:V,status:!0})}y(!1)},signInButton:D,handleSetSignUpPasswordValue:R,onKeepMeLoggedChange:z,handleHideEmailConfirmationForm:ee,handleConfirmPasswordChange:k,onBlurPassword:Y,onBlurConfirmPassword:Z}},lr=({requireRetypePassword:u=!1,addressesData:r,formSize:e="default",inputsDefaultValueSet:t,fieldsConfigForApiVersion1:c,apiVersion2:n=!0,isAutoSignInEnabled:i=!0,displayTermsOfUseCheckbox:F=!1,displayNewsletterCheckbox:E=!1,hideCloseBtnOnEmailConfirmation:M=!1,routeRedirectOnEmailConfirmationClose:h,routeRedirectOnSignIn:w,routeSignIn:b,onErrorCallback:S,onSuccessCallback:$,setActiveComponent:C,slots:o})=>{const a=Oe({title:"Auth.SignUpForm.title",buttonPrimary:"Auth.SignUpForm.buttonPrimary",buttonSecondary:"Auth.SignUpForm.buttonSecondary",privacyPolicyDefaultText:"Auth.SignUpForm.privacyPolicyDefaultText",subscribedDefaultText:"Auth.SignUpForm.subscribedDefaultText",keepMeLoggedText:"Auth.SignUpForm.keepMeLoggedText",customerTokenErrorMessage:"Auth.Api.customerTokenErrorMessage",failedCreateCustomerAddress:"Auth.SignUpForm.failedCreateCustomerAddress",placeholder:"Auth.InputPassword.placeholder",floatingLabel:"Auth.InputPassword.floatingLabel",requiredFieldError:"Auth.FormText.requiredFieldError",confirmPasswordPlaceholder:"Auth.SignUpForm.confirmPassword.placeholder",confirmPasswordFloatingLabel:"Auth.SignUpForm.confirmPassword.floatingLabel",passwordMismatch:"Auth.SignUpForm.confirmPassword.passwordMismatch"}),{passwordConfigs:g,isEmailConfirmationRequired:d}=ve(),{fieldsListConfigs:j}=Je({fieldsConfigForApiVersion1:c,apiVersion2:n,inputsDefaultValueSet:t}),{inLineAlertProps:N,handleSetInLineAlertProps:I}=Ke(),{showPasswordErrorMessage:v,confirmPassword:O,confirmPasswordMessage:q,isKeepMeLogged:l,userEmail:A,showEmailConfirmationForm:J,isSuccessful:G,isClickSubmit:Q,signUpPasswordValue:y,isLoading:H,onSubmitSignUp:X,signInButton:Y,handleSetSignUpPasswordValue:Z,onKeepMeLoggedChange:k,handleHideEmailConfirmationForm:z,handleConfirmPasswordChange:D,onBlurPassword:R,onBlurConfirmPassword:ee}=Xe({requireRetypePassword:u,addressesData:r,translations:a,isEmailConfirmationRequired:d,apiVersion2:n,passwordConfigs:g,isAutoSignInEnabled:i,routeRedirectOnSignIn:w,routeSignIn:b,onErrorCallback:S,onSuccessCallback:$,setActiveComponent:C,handleSetInLineAlertProps:I,routeRedirectOnEmailConfirmationClose:h}),{isValidUniqueSymbols:U,defaultLengthMessage:P}=qe({password:y,isClickSubmit:Q,passwordConfigs:g}),oe=xe(()=>v?a.requiredFieldError:U==="error"||(P==null?void 0:P.status)==="error"?" ":"",[P==null?void 0:P.status,U,v,a.requiredFieldError]),s=!d&&(r==null?void 0:r.length);return!j.length&&n?m("div",{className:`auth-sign-up-form auth-sign-up-form--${e} skeleton-loader`,"data-testid":"SignUpForm",children:m($e,{activeSkeleton:"signUpForm"})}):G.status&&(o!=null&&o.SuccessNotification)?m(Ne,{"data-testid":"successNotificationTestId",name:"SuccessNotification",slot:o==null?void 0:o.SuccessNotification,context:{isSuccessful:G}}):J?m(He,{formSize:e,userEmail:A,inLineAlertProps:N,hideCloseBtnOnEmailConfirmation:M,handleSetInLineAlertProps:I,onPrimaryButtonClick:z}):K("div",{className:ye(["auth-sign-up-form",`auth-sign-up-form--${e}`]),"data-testid":"SignUpForm",children:[m(Ve,{title:a.title,divider:!1,className:"auth-sign-up-form__title"}),N.text?m(We,{className:"auth-sign-up-form__notification",type:N.type,variant:"secondary",heading:N.text,icon:N.icon}):null,K(je,{onSubmit:X,className:"auth-sign-up-form__form",loading:H,name:"signUp_form",fieldsConfig:j,children:[K(ge,{validateLengthConfig:P,className:"auth-sign-up-form__form__field",autoComplete:"current-password",name:"password",minLength:g==null?void 0:g.minLength,errorMessage:oe,defaultValue:y,uniqueSymbolsStatus:U,requiredCharacterClasses:g==null?void 0:g.requiredCharacterClasses,onValue:Z,placeholder:a.placeholder,floatingLabel:a.floatingLabel,onBlur:R,children:[u?m("div",{className:"auth-sign-up-form__form__confirm-wrapper",children:m(ge,{className:"auth-sign-up-form__form__field auth-sign-up-form__form__field--confirm-password",autoComplete:"confirmPassword",name:"confirmPasswordField",placeholder:a.confirmPasswordPlaceholder,floatingLabel:a.confirmPasswordFloatingLabel,errorMessage:q,defaultValue:O,onValue:D,onBlur:ee})}):null,s?m("div",{className:"auth-sign-up-form__automatic-login","data-testid":"automaticLogin",children:m(se,{children:m(ie,{name:"",placeholder:a.keepMeLoggedText,label:a.keepMeLoggedText,checked:l,onChange:k})})}):null]}),E||F?K("div",{className:"auth-sign-up-form__item auth-sign-up-form__checkbox",children:[E?m(se,{children:m(ie,{"data-testid":"isSubscribed",name:"is_subscribed",placeholder:a.subscribedDefaultText,label:a.subscribedDefaultText})}):null,F?m(se,{children:m(ie,{"data-testid":"privacyPolicy",name:"privacyPolicy",placeholder:a.privacyPolicyDefaultText,label:a.privacyPolicyDefaultText})}):null]}):null,K("div",{className:"auth-sign-up-form-buttons",children:[m(he,{type:"button",variant:"tertiary",style:{padding:0},buttonText:a.buttonSecondary,enableLoader:!1,onClick:Y}),m(he,{type:"submit",buttonText:a.buttonPrimary,variant:"primary",enableLoader:H})]})]}),m("div",{id:"createCustomerV2"})]})};export{lr as S};
