/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as n,jsxs as j}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as Ue,classes as Le}from"@dropins/tools/lib.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/recaptcha.js";import{g as Me,c as Te,a as xe}from"./createCustomerAddress.js";import{useState as p,useEffect as Se,useCallback as L,useMemo as Ce}from"@dropins/tools/preact-hooks.js";import{s as fe,b as ve}from"./simplifyTransformAttributesForm.js";import{v as qe,u as Ae,a as Be}from"./usePasswordValidationMessage.js";import{a as Ke}from"./getCustomerToken.js";import{p as he,E as ge}from"./getStoreConfig.js";import{c as $,g as je,u as Ie,F as Ge,B as pe}from"./UpdatePasswordForm.js";import{c as He}from"./transform-attributes-form.js";import{f as Fe,E as Ve}from"./EmailConfirmationForm.js";import{Header as We,InLineAlert as $e,InputPassword as we,Field as ie,Checkbox as ae}from"@dropins/tools/components.js";/* empty css                       */import{S as Oe}from"./SkeletonLoader.js";import{useText as Je}from"@dropins/tools/i18n.js";const be=(u,t)=>t!=null&&t.length?u.map(e=>{var c;const s=(c=t.find(({code:m})=>m===e.code))==null?void 0:c.defaultValue;return s?{...e,defaultValue:s}:e}):u,Qe=({inputsDefaultValueSet:u,fieldsConfigForApiVersion1:t,apiVersion2:e})=>{const[s,c]=p([]);return Se(()=>{(async()=>{if(e){const o=await Me("customer_account_create");if(o!=null&&o.length)if(u!=null&&u.length){const F=be(o,u);c(F)}else c(o)}else{const o=fe(ve),F=fe(t),E=be(o,u);c(t&&t.length?F:E)}})()},[e,t,u]),{fieldsListConfigs:s}},Xe=(u,t)=>{const e=["date_of_birth","email","firstname","gender","is_subscribed","lastname","middlename","password","prefix","suffix","taxvat"],s=He(u,"snakeCase",{firstName:"firstname",lastName:"lastname"});if(!t)return{...s,...s!=null&&s.gender?{gender:Number(s==null?void 0:s.gender)}:{}};const c={},m=[];return Object.keys(s).forEach(o=>{e.includes(o)?c[o]=o.includes("gender")?Number(s[o]):s[o]:m.push({attribute_code:o,value:s[o]})}),m.length>0&&(c.custom_attributes=m),c},Ye=({requireRetypePassword:u,addressesData:t,translations:e,isEmailConfirmationRequired:s,apiVersion2:c=!0,passwordConfigs:m,isAutoSignInEnabled:o,routeRedirectOnSignIn:F,routeSignIn:E,onErrorCallback:M,onSuccessCallback:h,setActiveComponent:w,handleSetInLineAlertProps:b,routeRedirectOnEmailConfirmationClose:S})=>{const[O,C]=p(!1),[i,a]=p(""),[g,l]=p(""),[I,N]=p(""),[G,v]=p(!1),[J,q]=p({userName:"",status:!1}),[d,A]=p(""),[Q,H]=p(!1),[X,y]=p(!1),[V,Y]=p(!0),Z=L(r=>{const f=r.target.value;C(!f.length),f.length&&i.length&&f!==i&&l(e.passwordMismatch)},[i,e.passwordMismatch]),k=L(r=>{const f=r.target.value;l(f.length?"":e.requiredFieldError),f.length&&d.length&&f!==d&&l(e.passwordMismatch)},[d,e.passwordMismatch,e.requiredFieldError]),z=L(r=>{a(r),l(r?d===r?"":e.passwordMismatch:e.requiredFieldError)},[e,d]),D=L(({target:r})=>{Y(r.checked)},[]),R=L(()=>{if($(w)){w("signInForm");return}$(E)&&(window.location.href=E())},[w,E]),ee=L(r=>{A(r),C(!r.length),r===i&&l("")},[i]),re=L(()=>{b(),A(""),$(S)?window.location.href=S():(v(!1),w==null||w("signInForm"))},[b,S,w]),U=()=>{H(!0),y(!1)},P=(r,f)=>{const te=d.length&&i.length,me=d!==i,B=()=>{C(!d.length),i||l(e.requiredFieldError),te&&me&&l(e.passwordMismatch)};return f?(Fe(r,d,""),B(),!1):(U(),B(),!0)};return{showPasswordErrorMessage:O,confirmPassword:i,confirmPasswordMessage:g,isKeepMeLogged:V,userEmail:I,showEmailConfirmationForm:G,isSuccessful:J,isClickSubmit:Q,signUpPasswordValue:d,isLoading:X,onSubmitSignUp:async(r,f)=>{var ue,ce,de;if(b(),l(""),y(!0),P(r,f))return;if(u&&(g.length||d!==i)){U(),l(i.length?e.passwordMismatch:e.requiredFieldError),Fe(r,d,i);return}const te=c?"createCustomerV2":"createCustomer",{confirmPasswordField:me,...B}=je(r.target),{email:se,password:K,is_subscribed:Pe}=B,_e=(m==null?void 0:m.requiredCharacterClasses)||0,Ee=(m==null?void 0:m.minLength)||1;if(!qe(K,_e)||Ee>(K==null?void 0:K.length)){U();return}const Ne=Xe({...B,is_subscribed:!!Pe||!1},c),{data:T,errors:x}=await Te(Ne,c),W=((ce=(ue=T==null?void 0:T.createCustomer)==null?void 0:ue.customer)==null?void 0:ce.firstname)||"";if(x&&(x!=null&&x.length))b==null||b({type:"error",text:x[0].message}),M==null||M(x),he(ge.CREATE_ACCOUNT_EVENT,{updateProfile:!1}),N(se);else{const oe={email:"",...T==null?void 0:T[te]};if(he(ge.CREATE_ACCOUNT_EVENT,{email:oe==null?void 0:oe.email,updateProfile:!0}),s||!o){if(h==null||h({userName:W,status:!0}),s){(de=r.target)==null||de.reset(),A(""),v(!0),N(se),y(!1);return}if(!o){y(!1),q({userName:W,status:!0});return}}const _=await Ke({email:se,password:K,translations:e,handleSetInLineAlertProps:b,onErrorCallback:M});if(_!=null&&_.userName){if(t!=null&&t.length)for(const le of t)try{await xe(le)}catch(ye){console.error(e.failedCreateCustomerAddress,le,ye)}$(F)?window.location.href=F():(h==null||h({userName:_==null?void 0:_.userName,status:!0}),q({userName:_==null?void 0:_.userName,status:!0}))}else h==null||h({userName:W,status:!0}),q({userName:W,status:!0})}y(!1)},signInButton:R,handleSetSignUpPasswordValue:ee,onKeepMeLoggedChange:D,handleHideEmailConfirmationForm:re,handleConfirmPasswordChange:z,onBlurPassword:Z,onBlurConfirmPassword:k}},lr=({requireRetypePassword:u=!1,addressesData:t,formSize:e="default",inputsDefaultValueSet:s,fieldsConfigForApiVersion1:c,apiVersion2:m=!0,isAutoSignInEnabled:o=!0,displayTermsOfUseCheckbox:F=!1,displayNewsletterCheckbox:E=!1,hideCloseBtnOnEmailConfirmation:M=!1,routeRedirectOnEmailConfirmationClose:h,routeRedirectOnSignIn:w,routeSignIn:b,onErrorCallback:S,onSuccessCallback:O,setActiveComponent:C,slots:i})=>{const a=Je({title:"Auth.SignUpForm.title",buttonPrimary:"Auth.SignUpForm.buttonPrimary",buttonSecondary:"Auth.SignUpForm.buttonSecondary",privacyPolicyDefaultText:"Auth.SignUpForm.privacyPolicyDefaultText",subscribedDefaultText:"Auth.SignUpForm.subscribedDefaultText",keepMeLoggedText:"Auth.SignUpForm.keepMeLoggedText",customerTokenErrorMessage:"Auth.Api.customerTokenErrorMessage",failedCreateCustomerAddress:"Auth.SignUpForm.failedCreateCustomerAddress",placeholder:"Auth.InputPassword.placeholder",floatingLabel:"Auth.InputPassword.floatingLabel",requiredFieldError:"Auth.FormText.requiredFieldError",confirmPasswordPlaceholder:"Auth.SignUpForm.confirmPassword.placeholder",confirmPasswordFloatingLabel:"Auth.SignUpForm.confirmPassword.floatingLabel",passwordMismatch:"Auth.SignUpForm.confirmPassword.passwordMismatch"}),{passwordConfigs:g,isEmailConfirmationRequired:l}=Ae(),{fieldsListConfigs:I}=Qe({fieldsConfigForApiVersion1:c,apiVersion2:m,inputsDefaultValueSet:s}),{inLineAlertProps:N,handleSetInLineAlertProps:G}=Ie(),{showPasswordErrorMessage:v,confirmPassword:J,confirmPasswordMessage:q,isKeepMeLogged:d,userEmail:A,showEmailConfirmationForm:Q,isSuccessful:H,isClickSubmit:X,signUpPasswordValue:y,isLoading:V,onSubmitSignUp:Y,signInButton:Z,handleSetSignUpPasswordValue:k,onKeepMeLoggedChange:z,handleHideEmailConfirmationForm:D,handleConfirmPasswordChange:R,onBlurPassword:ee,onBlurConfirmPassword:re}=Ye({requireRetypePassword:u,addressesData:t,translations:a,isEmailConfirmationRequired:l,apiVersion2:m,passwordConfigs:g,isAutoSignInEnabled:o,routeRedirectOnSignIn:w,routeSignIn:b,onErrorCallback:S,onSuccessCallback:O,setActiveComponent:C,handleSetInLineAlertProps:G,routeRedirectOnEmailConfirmationClose:h}),{isValidUniqueSymbols:U,defaultLengthMessage:P}=Be({password:y,isClickSubmit:X,passwordConfigs:g}),ne=Ce(()=>v?a.requiredFieldError:U==="error"||(P==null?void 0:P.status)==="error"?" ":"",[P==null?void 0:P.status,U,v,a.requiredFieldError]),r=!l&&(t==null?void 0:t.length);return!I.length&&m?n("div",{className:`auth-sign-up-form auth-sign-up-form--${e} skeleton-loader`,"data-testid":"SignUpForm",children:n(Oe,{activeSkeleton:"signUpForm"})}):H.status&&(i!=null&&i.SuccessNotification)?n(Ue,{"data-testid":"successNotificationTestId",name:"SuccessNotification",slot:i==null?void 0:i.SuccessNotification,context:{isSuccessful:H}}):Q?n(Ve,{formSize:e,userEmail:A,inLineAlertProps:N,hideCloseBtnOnEmailConfirmation:M,handleSetInLineAlertProps:G,onPrimaryButtonClick:D}):j("div",{className:Le(["auth-sign-up-form",`auth-sign-up-form--${e}`]),"data-testid":"SignUpForm",children:[n(We,{title:a.title,divider:!1,className:"auth-sign-up-form__title"}),N.text?n($e,{className:"auth-sign-up-form__notification",type:N.type,variant:"secondary",heading:N.text,icon:N.icon}):null,j(Ge,{onSubmit:Y,className:"auth-sign-up-form__form",loading:V,name:"signUp_form",fieldsConfig:I,children:[j(we,{validateLengthConfig:P,className:"auth-sign-up-form__form__field",autoComplete:"current-password",name:"password",minLength:g==null?void 0:g.minLength,errorMessage:ne,defaultValue:y,uniqueSymbolsStatus:U,requiredCharacterClasses:g==null?void 0:g.requiredCharacterClasses,onValue:k,placeholder:a.placeholder,floatingLabel:a.floatingLabel,onBlur:ee,children:[u?n("div",{className:"auth-sign-up-form__form__confirm-wrapper",children:n(we,{className:"auth-sign-up-form__form__field auth-sign-up-form__form__field--confirm-password",autoComplete:"confirmPassword",name:"confirmPasswordField",placeholder:a.confirmPasswordPlaceholder,floatingLabel:a.confirmPasswordFloatingLabel,errorMessage:q,defaultValue:J,onValue:R,onBlur:re})}):null,r?n("div",{className:"auth-sign-up-form__automatic-login","data-testid":"automaticLogin",children:n(ie,{children:n(ae,{name:"",placeholder:a.keepMeLoggedText,label:a.keepMeLoggedText,checked:d,onChange:z})})}):null]}),E||F?j("div",{className:"auth-sign-up-form__item auth-sign-up-form__checkbox",children:[E?n(ie,{children:n(ae,{"data-testid":"isSubscribed",name:"is_subscribed",placeholder:a.subscribedDefaultText,label:a.subscribedDefaultText})}):null,F?n(ie,{children:n(ae,{"data-testid":"privacyPolicy",name:"privacyPolicy",placeholder:a.privacyPolicyDefaultText,label:a.privacyPolicyDefaultText})}):null]}):null,j("div",{className:"auth-sign-up-form-buttons",children:[n(pe,{type:"button",variant:"tertiary",style:{padding:0},buttonText:a.buttonSecondary,enableLoader:!1,onClick:Z}),n(pe,{type:"submit",buttonText:a.buttonPrimary,variant:"primary",enableLoader:V})]})]}),n("div",{id:"createCustomerV2"})]})};export{lr as S};
