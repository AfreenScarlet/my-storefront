/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as s,Fragment as S,jsxs as A}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as $,classes as _}from"@dropins/tools/lib.js";import{Button as P,InLineAlert as B,Modal as V,Card as K,Header as Q}from"@dropins/tools/components.js";import{useState as R,useEffect as H,useCallback as T}from"@dropins/tools/preact-hooks.js";import"../chunks/ShippingStatusCard.js";import{useMemo as J}from"@dropins/tools/preact-compat.js";import{u as G}from"../chunks/useGetStoreConfig.js";import"@dropins/tools/preact.js";import{events as I}from"@dropins/tools/event-bus.js";import{a as X,c as Y,r as Z}from"../chunks/confirmCancelOrder.js";import{useText as O,Text as M}from"@dropins/tools/i18n.js";import{C as D}from"../chunks/OrderLoaders.js";import{f as ee}from"../chunks/returnOrdersHelper.js";import{f as w}from"../chunks/formatDateToLocale.js";import{c as b}from"../chunks/capitalizeFirst.js";import{r as U}from"../chunks/redirectTo.js";import{O as te}from"../chunks/OrderCancelForm.js";import"../chunks/getStoreConfig.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/network-error.js";import"../fragments.js";import"../chunks/initialize.js";import"../chunks/getFormValues.js";import"../chunks/requestGuestOrderCancel.js";var y=(t=>(t.CANCEL="CANCEL",t.RETURN="RETURN",t.REORDER="REORDER",t))(y||{});const ne=({className:t,orderData:e,slots:r,routeCreateReturn:n,routeOnSuccess:l,onError:i})=>{const a=O({cancel:"Order.OrderStatusContent.actions.cancel",createReturn:"Order.OrderStatusContent.actions.createReturn",createAnotherReturn:"Order.OrderStatusContent.actions.createAnotherReturn",reorder:"Order.OrderStatusContent.actions.reorder"}),u=J(()=>{const c=e==null?void 0:e.availableActions,o=!!(c!=null&&c.length),d=!!(e!=null&&e.returnNumber),m=()=>{U(n,{},e)};return console.log("orderData",e),console.log("isReturnPage",d),console.log("orderData?.token",e==null?void 0:e.token),console.log("orderData?.id!",e==null?void 0:e.id),s(S,{children:r!=null&&r.OrderActions?s($,{"data-testid":"OrderActionsSlot",name:"OrderCanceledActions",slot:r==null?void 0:r.OrderActions,context:e}):s("div",{"data-testid":"availableActionsList",className:_(["order-order-actions__wrapper",["order-order-actions__wrapper--empty",!o]]),children:c==null?void 0:c.map(g=>{switch(g){case y.CANCEL:return s(S,{children:d?null:s(ce,{orderRef:(e==null?void 0:e.token)??(e==null?void 0:e.id)})});case y.RETURN:return s(P,{variant:"secondary",onClick:m,children:d?a.createAnotherReturn:a.createReturn});case y.REORDER:return s(S,{children:d?null:s(ie,{orderData:e,onError:i,routeOnSuccess:l,children:a.reorder})})}})})})},[i,e,l,n,r,a]);return s("div",{className:_(["order-order-actions",t]),children:u})},re=({orderData:t})=>{const[e,r]=R(t),[n,l]=R(t==null?void 0:t.status);return H(()=>{const i=I.on("order/data",a=>{r(a),l(a.status)},{eager:!0});return()=>{i==null||i.off()}},[]),{orderStatus:n,order:e}},k=t=>{const e=new URL(window.location.href);t.forEach(r=>{e.searchParams.has(r)&&e.searchParams.delete(r)}),window.history.replaceState({},document.title,e.toString())},se=({enableOrderCancellation:t})=>{const e=O({cancelOrderHeading:"Order.OrderStatusContent.actions.cancel",confirmGuestReturnHeading:"Order.OrderStatusContent.actions.confirmGuestReturn",orderCancelled:"Order.OrderStatusContent.orderCanceled.message",guestRequestReturnMessage:"Order.OrderStatusContent.actions.confirmGuestReturnMessage"}),[r,n]=R(!1),[l,i]=R(!1),[a,u]=R({heading:"",text:"",status:void 0}),c=T(()=>{n(!0),k(["order_id","confirmation_key","action"])},[]),o=T((d,m,g)=>{u({heading:d,text:m,status:g}),k(["action"])},[]);return H(()=>{const d=new URLSearchParams(window.location.search),m=d.get("order_id")??"",g=d.get("confirmation_key")??"",p=d.get("action")??"";l||!m||!g||!p||(t&&p==="cancel"&&(i(!0),X(m,g).then(()=>{u({heading:e.cancelOrderHeading,text:e.orderCancelled,status:"success"})}).catch(h=>{u({heading:e.cancelOrderHeading,text:h.message,status:"warning"})})),p==="return"&&(i(!0),Y(m,g).then(()=>{u({heading:e.confirmGuestReturnHeading,text:e.guestRequestReturnMessage,status:"success"})}).catch(h=>{u({heading:e.confirmGuestReturnHeading,text:h.message,status:"warning"})})))},[t,e,o,l]),{orderActionStatus:a,isDismissed:r,onDismiss:c}},be=({slots:t,orderData:e,className:r,statusTitle:n,status:l,routeCreateReturn:i,onError:a,routeOnSuccess:u})=>{const{orderStatus:c,order:o}=re({orderData:e}),d=G(),{orderActionStatus:m,isDismissed:g,onDismiss:p}=se({enableOrderCancellation:d==null?void 0:d.orderCancellationEnabled});return A("div",{className:_(["order-order-status",r]),children:[!g&&(m==null?void 0:m.status)!==void 0?s(B,{style:{marginBottom:"1rem"},heading:m.heading,onDismiss:p,description:m.text,type:m.status}):null,o?s(oe,{title:n,status:l||c,slots:t,orderData:o,routeCreateReturn:i,onError:a,routeOnSuccess:u}):s(D,{withCard:!1})]})},ce=({orderRef:t})=>{const[e,r]=R(!1),n=()=>{r(!0)},l=()=>{r(!1)},i=G(),a=(i==null?void 0:i.orderCancellationReasons)??[],u=c=>c.map((o,d)=>({text:o==null?void 0:o.description,value:d.toString()}));return I.on("order/data",c=>{const o=String(c.status).toLocaleLowerCase();(o==="guest order cancellation requested"||o==="canceled")&&l()}),A(S,{children:[s(P,{variant:"secondary",onClick:n,"data-testid":"cancel-button",children:s(M,{id:"Order.OrderStatusContent.actions.cancel"})}),e&&s(V,{centered:!0,size:"medium",onClose:l,className:"order-order-cancel__modal",title:s("h2",{className:"order-order-cancel__title",children:s(M,{id:"Order.OrderCancelForm.title"})}),"data-testid":"order-cancellation-reasons-modal",children:s(te,{orderRef:t,cancelReasons:u(a)})})]})},N={pending:"orderPending",shiping:"orderShipped",complete:"orderComplete",processing:"orderProcessing","on hold":"orderOnHold",canceled:"orderCanceled","suspected fraud":"orderSuspectedFraud","payment Review":"orderPaymentReview","order received":"orderReceived","guest order cancellation requested":"guestOrderCancellationRequested","pending payment":"orderPendingPayment",rejected:"orderRejected",authorized:"orderAuthorized","paypal canceled reversal":"orderPaypalCanceledReversal","pending paypal":"orderPendingPaypal","paypal reversed":"orderPaypalReversed",closed:"orderClosed"},oe=({slots:t,title:e,status:r,orderData:n,routeCreateReturn:l,onError:i,routeOnSuccess:a})=>{var x,E,L;const u=!!(n!=null&&n.returnNumber),c=String(r).toLocaleLowerCase(),o=(x=n==null?void 0:n.returns)==null?void 0:x[0],d=(o==null?void 0:o.returnStatus)??"",m=(o==null?void 0:o.createdReturnAt)??"",g=O({message:"Order.OrderStatusContent.orderPlaceholder.message",messageWithoutDate:"Order.OrderStatusContent.orderPlaceholder.messageWithoutDate"}),p=O(`Order.OrderStatusContent.${N[c]}.title`),h=O(`Order.OrderStatusContent.${N[c]}.message`),C=O(`Order.OrderStatusContent.${N[c]}.messageWithoutDate`),f=O({title:`Order.OrderStatusContent.returnStatus.${ee(d)}`,returnMessage:"Order.OrderStatusContent.returnMessage"});if(!r)return s("div",{});const q=p!=null&&p.title?p:{title:b(c)},v=h!=null&&h.message?h:g,F=C!=null&&C.messageWithoutDate?C:g,W=n!=null&&n.orderStatusChangeDate?v==null?void 0:v.message.replace("{DATE}",w(n==null?void 0:n.orderStatusChangeDate)):F.messageWithoutDate,j=((L=(E=f==null?void 0:f.returnMessage)==null?void 0:E.replace("{ORDER_CREATE_DATE}",w(n==null?void 0:n.orderDate)))==null?void 0:L.replace("{RETURN_CREATE_DATE}",w(m)))??"",z=u?e??(f.title||b(d)):e??q.title;return A(K,{className:"order-order-status-content",variant:"secondary",children:[s(Q,{title:z}),A("div",{className:"order-order-status-content__wrapper",children:[s("div",{className:_(["order-order-status-content__wrapper-description",["order-order-status-content__wrapper-description--actions-slot",!!(t!=null&&t.OrderActions)]]),children:s("p",{children:u?j:W})}),s(ne,{orderData:n,slots:t,routeCreateReturn:l,routeOnSuccess:a,onError:i})]})]})},ie=({onError:t,routeOnSuccess:e,orderData:r,children:n})=>{const[l,i]=R(!1),a=T(()=>{i(!0);const u=r==null?void 0:r.number;Z(u).then(({success:c,userInputErrors:o})=>{c&&U(e,{}),o.length&&(t==null||t(o))}).catch(c=>{t==null||t(c.message)}).finally(()=>{i(!1)})},[r,e,t]);return s(P,{type:"button",disabled:l,variant:"secondary",className:"order-reorder",onClick:a,children:n})};export{be as OrderStatus,be as default};
