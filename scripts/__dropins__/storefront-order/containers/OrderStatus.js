/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as n,Fragment as S,jsxs as _}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as z,classes as v}from"@dropins/tools/lib.js";import{Button as P,InLineAlert as q,Modal as H,Card as V,Header as B}from"@dropins/tools/components.js";import{useState as A,useEffect as G,useCallback as K}from"@dropins/tools/preact-hooks.js";import"../chunks/ShippingStatusCard.js";import{useMemo as J,useState as Q}from"@dropins/tools/preact-compat.js";import{u as M}from"../chunks/useGetStoreConfig.js";import"@dropins/tools/preact.js";import{events as F}from"@dropins/tools/event-bus.js";import{u as X}from"../chunks/useConfirmCancelOrder.js";import{C as Y}from"../chunks/OrderLoaders.js";import{f as Z}from"../chunks/returnOrdersHelper.js";import{f as T}from"../chunks/formatDateToLocale.js";import{c as x}from"../chunks/capitalizeFirst.js";import{useText as O,Text as k}from"@dropins/tools/i18n.js";import{r as I}from"../chunks/redirectTo.js";import{O as D}from"../chunks/OrderCancelForm.js";import{r as ee}from"../chunks/reorderItems.js";import"../chunks/getStoreConfig.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/getGuestOrder.graphql.js";import"../chunks/transform-customer-orders-returns.js";import"../chunks/convertCase.js";import"../chunks/getFormValues.js";import"../chunks/requestGuestOrderCancel.js";import"../chunks/network-error.js";var y=(e=>(e.CANCEL="CANCEL",e.RETURN="RETURN",e.REORDER="REORDER",e))(y||{});const te=({className:e,orderData:t,slots:s,routeCreateReturn:r,routeOnSuccess:a,onError:i})=>{const d=O({cancel:"Order.OrderStatusContent.actions.cancel",createReturn:"Order.OrderStatusContent.actions.createReturn",createAnotherReturn:"Order.OrderStatusContent.actions.createAnotherReturn",reorder:"Order.OrderStatusContent.actions.reorder"}),l=J(()=>{const c=t==null?void 0:t.availableActions,o=!!(c!=null&&c.length),u=!!(t!=null&&t.returnNumber),f=()=>{I(r,{},t)};return n(S,{children:s!=null&&s.OrderActions?n(z,{"data-testid":"OrderActionsSlot",name:"OrderCanceledActions",slot:s==null?void 0:s.OrderActions,context:t}):n("div",{"data-testid":"availableActionsList",className:v(["order-order-actions__wrapper",["order-order-actions__wrapper--empty",!o]]),children:c==null?void 0:c.map(h=>{switch(h){case y.CANCEL:return n(S,{children:u?null:n(ne,{orderRef:(t==null?void 0:t.token)??(t==null?void 0:t.id)})});case y.RETURN:return n(P,{variant:"secondary",onClick:f,children:u?d.createAnotherReturn:d.createReturn});case y.REORDER:return n(S,{children:u?null:n(ce,{orderData:t,onError:i,routeOnSuccess:a,children:d.reorder})})}})})})},[i,t,a,r,s,d]);return n("div",{className:v(["order-order-actions",e]),children:l})},re=({orderData:e})=>{const[t,s]=A(e),[r,a]=A(e==null?void 0:e.status);return G(()=>{const i=F.on("order/data",d=>{s(d),a(d.status)},{eager:!0});return()=>{i==null||i.off()}},[]),{orderStatus:r,order:t}},ke=({slots:e,orderData:t,className:s,statusTitle:r,status:a,routeCreateReturn:i,onError:d,routeOnSuccess:l})=>{const{orderStatus:c,order:o}=re({orderData:t}),[u,f]=Q(!1),h=()=>{f(!0);const p=new URL(window.location.href),N=p.searchParams.get("order_id"),g=p.searchParams.get("confirmation_key");N&&g&&(p.searchParams.delete("order_id"),p.searchParams.delete("confirmation_key"),window.history.replaceState({},document.title,p.toString()))},R=O({cancelOrder:"Order.OrderStatusContent.actions.cancel"}),C=M(),{confirmOrderCancellation:m}=X({enableOrderCancellation:C==null?void 0:C.orderCancellationEnabled});return _("div",{className:v(["order-order-status",s]),children:[!u&&(m==null?void 0:m.status)!==void 0&&n(q,{heading:R.cancelOrder,onDismiss:h,description:m.text,type:m.status}),o?n(se,{title:r,status:a||c,slots:e,orderData:o,routeCreateReturn:i,onError:d,routeOnSuccess:l}):n(Y,{withCard:!1})]})},ne=({orderRef:e})=>{const[t,s]=A(!1),r=()=>{s(!0)},a=()=>{s(!1)},i=M(),d=(i==null?void 0:i.orderCancellationReasons)??[],l=c=>c.map((o,u)=>({text:o==null?void 0:o.description,value:u.toString()}));return F.on("order/data",c=>{const o=String(c.status).toLocaleLowerCase();(o==="guest order cancellation requested"||o==="canceled")&&a()}),_(S,{children:[n(P,{variant:"secondary",onClick:r,"data-testid":"cancel-button",children:n(k,{id:"Order.OrderStatusContent.actions.cancel"})}),t&&n(H,{centered:!0,size:"medium",onClose:a,className:"order-order-cancel__modal",title:n("h2",{className:"order-order-cancel__title",children:n(k,{id:"Order.OrderCancelForm.title"})}),"data-testid":"order-cancellation-reasons-modal",children:n(D,{orderRef:e,cancelReasons:l(d)})})]})},w={pending:"orderPending",shiping:"orderShipped",complete:"orderComplete",processing:"orderProcessing","on hold":"orderOnHold",canceled:"orderCanceled","suspected fraud":"orderSuspectedFraud","payment Review":"orderPaymentReview","order received":"orderReceived","guest order cancellation requested":"guestOrderCancellationRequested","pending payment":"orderPendingPayment",rejected:"orderRejected",authorized:"orderAuthorized","paypal canceled reversal":"orderPaypalCanceledReversal","pending paypal":"orderPendingPaypal","paypal reversed":"orderPaypalReversed",closed:"orderClosed"},se=({slots:e,title:t,status:s,orderData:r,routeCreateReturn:a,onError:i,routeOnSuccess:d})=>{var E,b,L;const l=!!(r!=null&&r.returnNumber),c=String(s).toLocaleLowerCase(),o=(E=r==null?void 0:r.returns)==null?void 0:E[0],u=(o==null?void 0:o.returnStatus)??"",f=(o==null?void 0:o.createdReturnAt)??"",h=O({message:"Order.OrderStatusContent.orderPlaceholder.message",messageWithoutDate:"Order.OrderStatusContent.orderPlaceholder.messageWithoutDate"}),R=O(`Order.OrderStatusContent.${w[c]}.title`),C=O(`Order.OrderStatusContent.${w[c]}.message`),m=O(`Order.OrderStatusContent.${w[c]}.messageWithoutDate`),p=O({title:`Order.OrderStatusContent.returnStatus.${Z(u)}`,returnMessage:"Order.OrderStatusContent.returnMessage"});if(!s)return n("div",{});const N=R!=null&&R.title?R:{title:x(c)},g=C!=null&&C.message?C:h,U=m!=null&&m.messageWithoutDate?m:h,W=r!=null&&r.orderStatusChangeDate?g==null?void 0:g.message.replace("{DATE}",T(r==null?void 0:r.orderStatusChangeDate)):U.messageWithoutDate,$=((L=(b=p==null?void 0:p.returnMessage)==null?void 0:b.replace("{ORDER_CREATE_DATE}",T(r==null?void 0:r.orderDate)))==null?void 0:L.replace("{RETURN_CREATE_DATE}",T(f)))??"",j=l?t??(p.title||x(u)):t??N.title;return _(V,{className:"order-order-status-content",variant:"secondary",children:[n(B,{title:j}),_("div",{className:"order-order-status-content__wrapper",children:[n("div",{className:v(["order-order-status-content__wrapper-description",["order-order-status-content__wrapper-description--actions-slot",!!(e!=null&&e.OrderActions)]]),children:n("p",{children:l?$:W})}),n(te,{orderData:r,slots:e,routeCreateReturn:a,routeOnSuccess:d,onError:i})]})]})},ce=({onError:e,routeOnSuccess:t,orderData:s,children:r})=>{const[a,i]=A(!1),d=K(()=>{i(!0);const l=s==null?void 0:s.number;ee(l).then(({success:c,userInputErrors:o})=>{c&&I(t,{}),o.length&&(e==null||e(o))}).catch(c=>{e==null||e(c.message)}).finally(()=>{i(!1)})},[s,t,e]);return n(P,{type:"button",disabled:a,variant:"secondary",className:"order-reorder",onClick:d,children:r})};export{ke as OrderStatus,ke as default};
