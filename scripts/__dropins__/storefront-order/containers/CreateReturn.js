import{jsx as r,jsxs as x}from"@dropins/tools/preact-jsx-runtime.js";import{classes as $,Slot as B}from"@dropins/tools/lib.js";import{Checkbox as j,Button as M,CartItem as V,Image as W,Header as Z,InLineAlert as D}from"@dropins/tools/components.js";import{u as z,a as U}from"../chunks/OrderCancel.js";import{useState as v,useRef as K,useEffect as Q,useCallback as T}from"@dropins/tools/preact-hooks.js";import{events as G}from"@dropins/tools/event-bus.js";import{g as J}from"../chunks/getFormValues.js";import{s as X}from"../chunks/setTaxStatus.js";import{createRef as Y,Fragment as I}from"@dropins/tools/preact.js";import{c as ee,n as te,r as ne,m as re}from"../chunks/returnOrdersHelper.js";import{g as se,r as ae}from"../chunks/requestReturn.js";import{g as ie}from"../chunks/getStoreConfig.js";import*as C from"@dropins/tools/preact-compat.js";import{S as ce,C as ue}from"../chunks/CartSummaryItem.js";import{O as oe}from"../chunks/OrderLoaders.js";import{useText as le}from"@dropins/tools/i18n.js";import"../chunks/form.types.js";import"../chunks/network-error.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/transform-attributes-form.js";import"../chunks/convertCase.js";const de=s=>C.createElement("svg",{id:"Icon_Warning_Base",width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},C.createElement("g",{clipPath:"url(#clip0_841_1324)"},C.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M11.9949 2.30237L0.802734 21.6977H23.1977L11.9949 2.30237Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"}),C.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M12.4336 10.5504L12.3373 14.4766H11.6632L11.5669 10.5504V9.51273H12.4336V10.5504ZM11.5883 18.2636V17.2687H12.4229V18.2636H11.5883Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"})),C.createElement("defs",null,C.createElement("clipPath",{id:"clip0_841_1324"},C.createElement("rect",{width:24,height:21,fill:"white",transform:"translate(0 1.5)"})))),pe=s=>C.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},C.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M0.75 12C0.75 5.78421 5.78421 0.75 12 0.75C18.2158 0.75 23.25 5.78421 23.25 12C23.25 18.2158 18.2158 23.25 12 23.25C5.78421 23.25 0.75 18.2158 0.75 12Z",stroke:"currentColor"}),C.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M6.75 12.762L10.2385 15.75L17.25 9",stroke:"currentColor"})),he=({onSuccess:s,onError:a,handleSetInLineAlert:c,orderData:d})=>{const[u,f]=v(d),[w,k]=v("products"),[L,y]=v(!0),[p,g]=v([]),[R,S]=v([]),[t,b]=v({taxIncluded:!1,taxExcluded:!1}),[e,o]=v([]),h=K([]);h.current.length!==p.length&&(h.current=p.map((n,l)=>h.current[l]||Y())),Q(()=>{const n=G.on("order/data",l=>{f(l);const _=l.items.sort((i,m)=>{const F=i.quantityShipped-i.quantityReturnRequested===0,A=m.quantityShipped-m.quantityReturnRequested===0;return F&&!A?1:!F&&A?-1:0});o(_),y(!1)},{eager:!0});return()=>{n==null||n.off()}},[]),Q(()=>{ie().then(n=>{if(n){const l=X(n==null?void 0:n.shoppingCartDisplayPrice);b(l)}})},[]),Q(()=>{se("RMA_ITEM").then(n=>{n.length&&(S(n),y(!1))})},[]);const N=T(n=>{g(l=>l.findIndex(i=>(i==null?void 0:i.productSku)===(n==null?void 0:n.productSku))>-1?l.filter(i=>(i==null?void 0:i.productSku)!==(n==null?void 0:n.productSku)):[...l,n])},[]),O=T(n=>{k(n),c(),n==="products"&&g([])},[c]),q=T((n,l)=>{const _=p.map(i=>i.productSku===l?{...i,currentReturnOrderQuantity:n}:i);g(_)},[p]),E=T(async(n,l)=>{if(!l)return null;y(!0);const _={orderUid:(u==null?void 0:u.id)??"",contactEmail:(u==null?void 0:u.email)??""},i=[];h.current.length&&h.current.forEach(({current:m})=>{var P;const F=m==null?void 0:m.name.replace(/_\d+$/,""),A=((P=m==null?void 0:m.dataset)==null?void 0:P.quantity)??1,H=ee(J(m));i.push({orderItemUid:F,quantityToReturn:+A,...te(H)})}),ae({..._,items:i}).then(m=>{m&&(s==null||s(m),O("success"),c())}).catch(m=>{a==null||a(m.message),c({type:"error",heading:m.message})}),y(!1)},[O,a,s,c,u]);return{order:u,steps:w,loading:L,formsRef:h,taxConfig:t,attributesList:R,selectedProductList:p,itemsEligibleForReturn:e,handleSelectedProductList:N,handleSetQuantity:q,handleChangeStep:O,onSubmit:E}},me={success:r(pe,{}),warning:r(de,{}),error:r(ce,{})},fe=()=>{const[s,a]=v({type:"success",heading:""}),c=T(d=>{if(!(d!=null&&d.type)){a({type:"success",heading:""});return}const u=me[d.type];a({...d,icon:u})},[]);return{inLineAlertProps:s,handleSetInLineAlert:c}},ge=({itemsEligibleForReturn:s,slots:a,loading:c=!1,taxConfig:d,translations:u={},selectedProductList:f,handleSelectedProductList:w,showConfigurableOptions:k,handleSetQuantity:L,handleChangeStep:y})=>x("ul",{className:"order-return-order-product-list",children:[s==null?void 0:s.map((p,g)=>{const{quantityReturnRequested:R,quantityShipped:S,eligibleForReturn:t}=p,b=f.some(h=>(h==null?void 0:h.productSku)===p.productSku&&p.eligibleForReturn),e=S===R&&t,o=S-R===0?R:S-R;return x("li",{className:$(["order-return-order-product-list__item",["order-return-order-product-list__item--blur",e]]),children:[r(j,{"data-testid":`key_${g}`,name:`key_${g}`,checked:b,disabled:e,onChange:()=>{w({...p,currentReturnOrderQuantity:1})}}),r(ue,{loading:c,product:{...p,totalQuantity:o},itemType:"",taxConfig:d,translations:u,showConfigurableOptions:k,disabledIncrementer:!b,onQuantity:o>1?h=>L(h,p.productSku):void 0}),r(B,{"data-testid":"returnOrderItem",name:"ReturnOrderItem",slot:a==null?void 0:a.ReturnOrderItem})]},g)}),r("li",{className:"order-return-order-product-list__item",children:r(M,{type:"button",onClick:()=>y("attributes"),disabled:!f.length,children:u.nextStep})})]}),be=({routeReturnSuccess:s,translations:a,orderData:c})=>{const d=()=>{window.location.href=(s==null?void 0:s(c))??"#"};return x("div",{className:"order-return-order-message",children:[r("p",{className:"order-return-order-message__title",children:a.successTitle}),r("p",{className:"order-return-order-message__subtitle",children:a.successMessage}),r(M,{onClick:d,type:"button",children:a.backStore})]})},ke=({slots:s,formsRef:a,selectedProductList:c,loading:d,fieldsConfig:u,translations:f,handleChangeStep:w,onSubmit:k})=>{const{formData:L,errors:y,formRef:p,handleChange:g,handleBlur:R,handleSubmit:S}=z({fieldsConfig:ne(u,c==null?void 0:c.length),onSubmit:k});return x("form",{className:"order-return-reason-form",ref:p,onSubmit:S,name:"returnReasonForm",children:[c.map((t,b)=>{var E,n,l,_,i;const e=(t==null?void 0:t.giftCard)||{},o=t==null?void 0:t.product,h=re(u,b),N=`${t==null?void 0:t.id}_${b}`,O=(t==null?void 0:t.currentReturnOrderQuantity)??1,q={...t!=null&&t.currentReturnOrderQuantity?{Quantity:O}:{},..."configurableOptions"in t?t.configurableOptions:{},..."bundleOptions"in t?t.bundleOptions:{},..."senderName"in e?{[f.sender]:e==null?void 0:e.senderName}:{},..."senderEmail"in e&&(e!=null&&e.senderEmail)?{[f.sender]:e==null?void 0:e.senderEmail}:{},..."recipientName"in e&&(e!=null&&e.recipientName)?{[f.recipient]:e==null?void 0:e.recipientName}:{},..."recipientEmail"in e&&(e!=null&&e.recipientEmail)?{[f.recipient]:e==null?void 0:e.recipientEmail}:{},..."message"in e&&(e!=null&&e.message)?{[f.message]:e==null?void 0:e.message}:{},..."downloadableLinks"in t&&(t!=null&&t.downloadableLinks)?{[`${(E=t==null?void 0:t.downloadableLinks)==null?void 0:E.count} ${f.downloadableCount}`]:(n=t==null?void 0:t.downloadableLinks)==null?void 0:n.result}:{}};return x(I,{children:[r(V,{loading:d,title:r("div",{"data-testid":"product-name",children:(l=t==null?void 0:t.product)==null?void 0:l.name}),sku:r("div",{children:o==null?void 0:o.sku}),image:r(W,{src:((_=o==null?void 0:o.thumbnail)==null?void 0:_.url)??"",alt:((i=o==null?void 0:o.thumbnail)==null?void 0:i.label)??"",loading:"lazy",width:"90",height:"120"}),configurations:q}),r("form",{name:N,ref:a==null?void 0:a.current[b],"data-quantity":O,children:r(U,{className:"className",loading:d,fields:h,onChange:g,onBlur:R,errors:y,values:L})})]},b)}),r(B,{"data-testid":"returnFormActions",name:"ReturnFormActions",slot:s==null?void 0:s.ReturnFormActions,context:{handleChangeStep:w},children:x("div",{className:"order-return-reason-form__actions",children:[r(M,{variant:"secondary",type:"button",onClick:()=>{w("products")},children:f.backStep}),r(M,{children:f.submit})]})})]})},He=({className:s,orderData:a,slots:c,onSuccess:d,onError:u,routeReturnSuccess:f,showConfigurableOptions:w})=>{const k=le({headerText:"Order.CreateReturn.headerText",successTitle:"Order.CreateReturn.success.title",successMessage:"Order.CreateReturn.success.message",sender:"Order.CreateReturn.giftCard.sender",recipient:"Order.CreateReturn.giftCard.recipient",message:"Order.CreateReturn.giftCard.message",outOfStock:"Order.CreateReturn.stockStatus.outOfStock",nextStep:"Order.CreateReturn.buttons.nextStep",backStep:"Order.CreateReturn.buttons.backStep",submit:"Order.CreateReturn.buttons.submit",backStore:"Order.CreateReturn.buttons.backStore",downloadableCount:"Order.CreateReturn.downloadableCount",returnedItems:"Order.CreateReturn.returnedItems"}),{inLineAlertProps:L,handleSetInLineAlert:y}=fe(),{order:p,itemsEligibleForReturn:g,formsRef:R,taxConfig:S,attributesList:t,steps:b,loading:e,selectedProductList:o,handleSelectedProductList:h,handleSetQuantity:N,handleChangeStep:O,onSubmit:q}=he({orderData:a,onSuccess:d,onError:u,handleSetInLineAlert:y});if(e)return r("div",{children:r(oe,{})});if(!e&&!t.length)return r("div",{});const E={products:r(ge,{itemsEligibleForReturn:g,slots:c,translations:k,loading:e,taxConfig:S,selectedProductList:o,handleSelectedProductList:h,showConfigurableOptions:w,handleSetQuantity:N,handleChangeStep:O}),attributes:r(ke,{slots:c,formsRef:R,loading:e,fieldsConfig:t,selectedProductList:o,handleChangeStep:O,translations:k,onSubmit:q}),success:r(be,{translations:k,routeReturnSuccess:f,orderData:p}),error:null};return x("div",{className:$(["order-create-return",s]),children:[r(Z,{title:k.headerText}),L.heading?r(D,{className:"order-create-return_notification",variant:"secondary","data-testid":"orderCreateReturnNotification",...L}):null,E[b]]})};export{He as CreateReturn,He as default};
