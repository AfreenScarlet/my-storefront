import{jsx as r,jsxs as F}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as B,classes as H}from"@dropins/tools/lib.js";import{Button as M,CartItem as Q,Image as V,Header as W,InLineAlert as $}from"@dropins/tools/components.js";import{S as Z,u as z,a as D,R as K}from"../chunks/OrderCancel.js";import{useState as L,useRef as U,useEffect as T,useCallback as N}from"@dropins/tools/preact-hooks.js";import{events as G}from"@dropins/tools/event-bus.js";import{g as J}from"../chunks/getFormValues.js";import{s as X}from"../chunks/setTaxStatus.js";import{createRef as Y,Fragment as I}from"@dropins/tools/preact.js";import{c as ee,n as te,r as ne,m as se}from"../chunks/returnOrdersHelper.js";import{a as re}from"../chunks/deprecatedAdjustments.js";import{g as ae,r as ie}from"../chunks/requestReturn.js";import{g as ce}from"../chunks/getStoreConfig.js";import*as h from"@dropins/tools/preact-compat.js";import{O as oe}from"../chunks/OrderLoaders.js";import{useText as ue}from"@dropins/tools/i18n.js";import"../chunks/form.types.js";import"../chunks/network-error.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/transform-attributes-form.js";import"../chunks/convertCase.js";const le=s=>h.createElement("svg",{id:"Icon_Warning_Base",width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},h.createElement("g",{clipPath:"url(#clip0_841_1324)"},h.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M11.9949 2.30237L0.802734 21.6977H23.1977L11.9949 2.30237Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"}),h.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M12.4336 10.5504L12.3373 14.4766H11.6632L11.5669 10.5504V9.51273H12.4336V10.5504ZM11.5883 18.2636V17.2687H12.4229V18.2636H11.5883Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"})),h.createElement("defs",null,h.createElement("clipPath",{id:"clip0_841_1324"},h.createElement("rect",{width:24,height:21,fill:"white",transform:"translate(0 1.5)"})))),de=s=>h.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},h.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M0.75 12C0.75 5.78421 5.78421 0.75 12 0.75C18.2158 0.75 23.25 5.78421 23.25 12C23.25 18.2158 18.2158 23.25 12 23.25C5.78421 23.25 0.75 18.2158 0.75 12Z",stroke:"currentColor"}),h.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M6.75 12.762L10.2385 15.75L17.25 9",stroke:"currentColor"})),pe=({onSuccess:s,onError:i,handleSetInLineAlert:c,orderData:l})=>{const[b,d]=L(l),[S,k]=L("products"),[v,R]=L(!0),[g,w]=L([]),[x,y]=L([]),[t,p]=L({taxIncluded:!1,taxExcluded:!1}),[e,u]=L([]),m=U([]);m.current.length!==g.length&&(m.current=g.map((n,o)=>m.current[o]||Y())),T(()=>{const n=G.on("order/data",o=>{d(o),u(re(o)),R(!1)},{eager:!0});return()=>{n==null||n.off()}},[]),T(()=>{ce().then(n=>{if(n){const o=X(n==null?void 0:n.shoppingCartDisplayPrice);p(o)}})},[]),T(()=>{ae("RMA_ITEM").then(n=>{n.length&&(y(n),R(!1))})},[]);const E=N(n=>{w(o=>o.some(f=>(f==null?void 0:f.productSku)===(n==null?void 0:n.productSku))?o.filter(f=>(f==null?void 0:f.productSku)!==(n==null?void 0:n.productSku)):[...o,n])},[]),C=N(n=>{k(n),c(),n==="products"&&w([])},[c]),_=N((n,o)=>{const O=g.map(a=>a.productSku===o?{...a,currentReturnOrderQuantity:n}:a);w(O)},[g]),A=N(async(n,o)=>{if(!o)return null;R(!0);const O=[];m.current.length&&m.current.forEach(({current:a})=>{var P;const f=a==null?void 0:a.name.replace(/_\d+$/,""),j=((P=a==null?void 0:a.dataset)==null?void 0:P.quantity)??1,q=ee(J(a));O.push({orderItemUid:f,quantityToReturn:+j,...te(q)})}),ie({...orderReturnInfo,items:O}).then(a=>{a&&(s==null||s(a),C("success"),c())}).catch(a=>{i==null||i(a.message),c({type:"error",heading:a.message})}),R(!1)},[C,i,s,c,orderReturnInfo]);return{order:b,steps:S,loading:v,formsRef:m,taxConfig:t,orderReturnInfo,attributesList:x,selectedProductList:g,itemsEligibleForReturn:e,handleSelectedProductList:E,handleSetQuantity:_,handleChangeStep:C,onSubmit:A}},me={success:r(de,{}),warning:r(le,{}),error:r(Z,{})},he=()=>{const[s,i]=L({type:"success",heading:""}),c=N(l=>{if(!(l!=null&&l.type)){i({type:"success",heading:""});return}const b=me[l.type];i({...l,icon:b})},[]);return{inLineAlertProps:s,handleSetInLineAlert:c}},ge=({routeReturnSuccess:s,translations:i})=>{const c=()=>{window.location.href=(s==null?void 0:s())??""};return F("div",{className:"order-return-order-message",children:[r("p",{className:"order-return-order-message__title",children:i.successTitle}),r("p",{className:"order-return-order-message__subtitle",children:i.successMessage}),r(M,{onClick:c,type:"button",children:i.backStore})]})},fe=({slots:s,formsRef:i,selectedProductList:c,loading:l,fieldsConfig:b,translations:d,handleChangeStep:S,onSubmit:k})=>{const{formData:v,errors:R,formRef:g,handleChange:w,handleBlur:x,handleSubmit:y}=z({fieldsConfig:ne(b,c==null?void 0:c.length),onSubmit:k});return F("form",{className:"order-return-reason-form",ref:g,onSubmit:y,name:"returnReasonForm",children:[c.map((t,p)=>{var A,n,o,O,a;const e=(t==null?void 0:t.giftCard)||{},u=t==null?void 0:t.product,m=se(b,p),E=`${t==null?void 0:t.id}_${p}`,C=(t==null?void 0:t.currentReturnOrderQuantity)??1,_={..."configurableOptions"in t?t.configurableOptions:{},..."bundleOptions"in t?t.bundleOptions:{},..."senderName"in e&&(e!=null&&e.senderName)?{[d.sender]:e==null?void 0:e.senderName}:{},..."senderEmail"in e&&(e!=null&&e.senderEmail)?{[d.sender]:e==null?void 0:e.senderEmail}:{},..."recipientName"in e&&(e!=null&&e.recipientName)?{[d.recipient]:e==null?void 0:e.recipientName}:{},..."recipientEmail"in e&&(e!=null&&e.recipientEmail)?{[d.recipient]:e==null?void 0:e.recipientEmail}:{},..."message"in e&&(e!=null&&e.message)?{[d.message]:e==null?void 0:e.message}:{},..."downloadableLinks"in t&&(t!=null&&t.downloadableLinks)?{[`${(A=t==null?void 0:t.downloadableLinks)==null?void 0:A.count} ${d.downloadableCount}`]:(n=t==null?void 0:t.downloadableLinks)==null?void 0:n.result}:{}};return F(I,{children:[r(Q,{loading:l,title:r("div",{"data-testid":"product-name",children:(o=t==null?void 0:t.product)==null?void 0:o.name}),sku:r("div",{children:u==null?void 0:u.sku}),quantity:C,onQuantity:void 0,image:r(V,{src:((O=u==null?void 0:u.thumbnail)==null?void 0:O.url)??"",alt:((a=u==null?void 0:u.thumbnail)==null?void 0:a.label)??"",loading:"lazy",width:"90",height:"120"}),configurations:_}),r("form",{name:E,ref:i==null?void 0:i.current[p],"data-quantity":C,children:r(D,{className:"className",loading:l,fields:m,onChange:w,onBlur:x,errors:R,values:v})})]},p)}),s!=null&&s.ReturnFormActions?r(B,{"data-testid":"returnFormActions",name:"ReturnFormActions",slot:s==null?void 0:s.ReturnFormActions,context:{handleChangeStep:S}}):F("div",{className:"order-return-reason-form__actions",children:[r(M,{variant:"secondary",type:"button",onClick:()=>{S("products")},children:d.backStep}),r(M,{children:d.submit})]})]})},Be=({className:s,orderData:i,slots:c,onSuccess:l,onError:b,routeReturnSuccess:d,showConfigurableOptions:S})=>{const k=ue({headerText:"Order.CreateReturn.headerText",successTitle:"Order.CreateReturn.success.title",successMessage:"Order.CreateReturn.success.message",sender:"Order.CreateReturn.giftCard.sender",recipient:"Order.CreateReturn.giftCard.recipient",message:"Order.CreateReturn.giftCard.message",outOfStock:"Order.CreateReturn.stockStatus.outOfStock",nextStep:"Order.CreateReturn.buttons.nextStep",backStep:"Order.CreateReturn.buttons.backStep",submit:"Order.CreateReturn.buttons.submit",backStore:"Order.CreateReturn.buttons.backStore",downloadableCount:"Order.CreateReturn.downloadableCount",returnedItems:"Order.CreateReturn.returnedItems"});console.log("orderData",i);const{inLineAlertProps:v,handleSetInLineAlert:R}=he(),{itemsEligibleForReturn:g,formsRef:w,taxConfig:x,attributesList:y,steps:t,loading:p,selectedProductList:e,handleSelectedProductList:u,handleSetQuantity:m,handleChangeStep:E,onSubmit:C}=pe({orderData:i,onSuccess:l,onError:b,handleSetInLineAlert:R});if(p)return r("div",{children:r(oe,{})});if(!p&&!y.length)return r("div",{});const _={products:r(K,{itemsEligibleForReturn:g,slots:c,translations:k,loading:p,taxConfig:x,selectedProductList:e,handleSelectedProductList:u,showConfigurableOptions:S,handleSetQuantity:m,handleChangeStep:E}),attributes:r(fe,{slots:c,formsRef:w,loading:p,fieldsConfig:y,selectedProductList:e,handleChangeStep:E,translations:k,onSubmit:C}),success:r(ge,{translations:k,routeReturnSuccess:d}),error:null};return F("div",{className:H(["order-create-return",s]),children:[r(W,{title:k.headerText}),v.heading?r($,{className:"order-create-return_notification",variant:"secondary","data-testid":"orderCreateReturnNotification",...v}):null,_[t]]})};export{Be as CreateReturn,Be as default};
