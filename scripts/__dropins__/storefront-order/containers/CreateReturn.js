import{jsx as r,jsxs as A}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as Q,classes as V}from"@dropins/tools/lib.js";import{Button as j,CartItem as W,Image as $,Header as Z,InLineAlert as U}from"@dropins/tools/components.js";import{S as z,u as D,a as K,R as G}from"../chunks/OrderCancel.js";import{useState as b,useRef as J,useEffect as P,useCallback as F}from"@dropins/tools/preact-hooks.js";import{events as X}from"@dropins/tools/event-bus.js";import{g as Y}from"../chunks/getFormValues.js";import{s as I}from"../chunks/setTaxStatus.js";import{createRef as ee,Fragment as te}from"@dropins/tools/preact.js";import{c as ne,n as se,r as ae,m as re}from"../chunks/returnOrdersHelper.js";import{a as ie}from"../chunks/deprecatedAdjustments.js";import{g as ce,r as oe}from"../chunks/requestReturn.js";import{g as ue}from"../chunks/getStoreConfig.js";import*as h from"@dropins/tools/preact-compat.js";import{O as le}from"../chunks/OrderLoaders.js";import{useText as pe}from"@dropins/tools/i18n.js";import"../chunks/form.types.js";import"../chunks/network-error.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/transform-attributes-form.js";import"../chunks/convertCase.js";const de=s=>h.createElement("svg",{id:"Icon_Warning_Base",width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},h.createElement("g",{clipPath:"url(#clip0_841_1324)"},h.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M11.9949 2.30237L0.802734 21.6977H23.1977L11.9949 2.30237Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"}),h.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M12.4336 10.5504L12.3373 14.4766H11.6632L11.5669 10.5504V9.51273H12.4336V10.5504ZM11.5883 18.2636V17.2687H12.4229V18.2636H11.5883Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"})),h.createElement("defs",null,h.createElement("clipPath",{id:"clip0_841_1324"},h.createElement("rect",{width:24,height:21,fill:"white",transform:"translate(0 1.5)"})))),me=s=>h.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},h.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M0.75 12C0.75 5.78421 5.78421 0.75 12 0.75C18.2158 0.75 23.25 5.78421 23.25 12C23.25 18.2158 18.2158 23.25 12 23.25C5.78421 23.25 0.75 18.2158 0.75 12Z",stroke:"currentColor"}),h.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M6.75 12.762L10.2385 15.75L17.25 9",stroke:"currentColor"})),he=({onSuccess:s,onError:c,handleSetInLineAlert:o,orderData:l})=>{const[k,p]=b(l),[R,C]=b({orderUid:"",contactEmail:""}),[w,v]=b("products"),[y,O]=b(!0),[g,L]=b([]),[t,m]=b([]),[e,u]=b({taxIncluded:!1,taxExcluded:!1}),[x,E]=b([]),d=J([]);d.current.length!==g.length&&(d.current=g.map((n,a)=>d.current[a]||ee())),P(()=>{const n=X.on("order/data",a=>{p(a),E(ie(a)),C({orderUid:(a==null?void 0:a.id)??"",contactEmail:(a==null?void 0:a.email)??""}),O(!1)},{eager:!0});return()=>{n==null||n.off()}},[]),P(()=>{ue().then(n=>{if(n){const a=I(n==null?void 0:n.shoppingCartDisplayPrice);u(a)}})},[]),P(()=>{ce("RMA_ITEM").then(n=>{n.length&&(m(n),O(!1))})},[]);const _=F(n=>{L(a=>a.some(f=>(f==null?void 0:f.productSku)===(n==null?void 0:n.productSku))?a.filter(f=>(f==null?void 0:f.productSku)!==(n==null?void 0:n.productSku)):[...a,n])},[]),S=F(n=>{v(n),o(),n==="products"&&L([])},[o]),T=F((n,a)=>{const N=g.map(i=>i.productSku===a?{...i,currentReturnOrderQuantity:n}:i);L(N)},[g]),M=F(async(n,a)=>{if(!a)return null;O(!0);const N=[];d.current.length&&d.current.forEach(({current:i})=>{var q;const f=i==null?void 0:i.name.replace(/_\d+$/,""),B=((q=i==null?void 0:i.dataset)==null?void 0:q.quantity)??1,H=ne(Y(i));N.push({orderItemUid:f,quantityToReturn:+B,...se(H)})}),oe({...R,items:N}).then(i=>{i&&(s==null||s(i),S("success"),o())}).catch(i=>{c==null||c(i.message),o({type:"error",heading:i.message})}),O(!1)},[S,c,s,o,R]);return{order:k,steps:w,loading:y,formsRef:d,taxConfig:e,orderReturnInfo:R,attributesList:t,selectedProductList:g,itemsEligibleForReturn:x,handleSelectedProductList:_,handleSetQuantity:T,handleChangeStep:S,onSubmit:M}},ge={success:r(me,{}),warning:r(de,{}),error:r(z,{})},fe=()=>{const[s,c]=b({type:"success",heading:""}),o=F(l=>{if(!(l!=null&&l.type)){c({type:"success",heading:""});return}const k=ge[l.type];c({...l,icon:k})},[]);return{inLineAlertProps:s,handleSetInLineAlert:o}},be=({routeReturnSuccess:s,translations:c})=>{const o=()=>{window.location.href=(s==null?void 0:s())??""};return A("div",{className:"order-return-order-message",children:[r("p",{className:"order-return-order-message__title",children:c.successTitle}),r("p",{className:"order-return-order-message__subtitle",children:c.successMessage}),r(j,{onClick:o,type:"button",children:c.backStore})]})},ke=({slots:s,formsRef:c,selectedProductList:o,loading:l,fieldsConfig:k,translations:p,handleChangeStep:R,onSubmit:C})=>{const{formData:w,errors:v,formRef:y,handleChange:O,handleBlur:g,handleSubmit:L}=D({fieldsConfig:ae(k,o==null?void 0:o.length),onSubmit:C});return A("form",{className:"order-return-reason-form",ref:y,onSubmit:L,name:"returnReasonForm",children:[o.map((t,m)=>{var S,T,M,n,a;const e=(t==null?void 0:t.giftCard)||{},u=t==null?void 0:t.product,x=re(k,m),E=`${t==null?void 0:t.id}_${m}`,d=(t==null?void 0:t.currentReturnOrderQuantity)??1,_={..."configurableOptions"in t?t.configurableOptions:{},..."bundleOptions"in t?t.bundleOptions:{},..."senderName"in e&&(e!=null&&e.senderName)?{[p.sender]:e==null?void 0:e.senderName}:{},..."senderEmail"in e&&(e!=null&&e.senderEmail)?{[p.sender]:e==null?void 0:e.senderEmail}:{},..."recipientName"in e&&(e!=null&&e.recipientName)?{[p.recipient]:e==null?void 0:e.recipientName}:{},..."recipientEmail"in e&&(e!=null&&e.recipientEmail)?{[p.recipient]:e==null?void 0:e.recipientEmail}:{},..."message"in e&&(e!=null&&e.message)?{[p.message]:e==null?void 0:e.message}:{},..."downloadableLinks"in t&&(t!=null&&t.downloadableLinks)?{[`${(S=t==null?void 0:t.downloadableLinks)==null?void 0:S.count} ${p.downloadableCount}`]:(T=t==null?void 0:t.downloadableLinks)==null?void 0:T.result}:{}};return A(te,{children:[r(W,{loading:l,title:r("div",{"data-testid":"product-name",children:(M=t==null?void 0:t.product)==null?void 0:M.name}),sku:r("div",{children:u==null?void 0:u.sku}),quantity:d,onQuantity:void 0,image:r($,{src:((n=u==null?void 0:u.thumbnail)==null?void 0:n.url)??"",alt:((a=u==null?void 0:u.thumbnail)==null?void 0:a.label)??"",loading:"lazy",width:"90",height:"120"}),configurations:_}),r("form",{name:E,ref:c==null?void 0:c.current[m],"data-quantity":d,children:r(K,{className:"className",loading:l,fields:x,onChange:O,onBlur:g,errors:v,values:w})})]},m)}),s!=null&&s.ReturnFormActions?r(Q,{"data-testid":"returnFormActions",name:"ReturnFormActions",slot:s==null?void 0:s.ReturnFormActions,context:{handleChangeStep:R}}):A("div",{className:"order-return-reason-form__actions",children:[r(j,{variant:"secondary",type:"button",onClick:()=>{R("products")},children:p.backStep}),r(j,{children:p.submit})]})]})},Qe=({className:s,orderData:c,slots:o,onSuccess:l,onError:k,routeReturnSuccess:p,showConfigurableOptions:R})=>{const C=pe({headerText:"Order.CreateReturn.headerText",successTitle:"Order.CreateReturn.success.title",successMessage:"Order.CreateReturn.success.message",sender:"Order.CreateReturn.giftCard.sender",recipient:"Order.CreateReturn.giftCard.recipient",message:"Order.CreateReturn.giftCard.message",outOfStock:"Order.CreateReturn.stockStatus.outOfStock",nextStep:"Order.CreateReturn.buttons.nextStep",backStep:"Order.CreateReturn.buttons.backStep",submit:"Order.CreateReturn.buttons.submit",backStore:"Order.CreateReturn.buttons.backStore",downloadableCount:"Order.CreateReturn.downloadableCount",returnedItems:"Order.CreateReturn.returnedItems"}),{inLineAlertProps:w,handleSetInLineAlert:v}=fe(),{itemsEligibleForReturn:y,formsRef:O,taxConfig:g,attributesList:L,steps:t,loading:m,selectedProductList:e,handleSelectedProductList:u,handleSetQuantity:x,handleChangeStep:E,onSubmit:d}=he({orderData:c,onSuccess:l,onError:k,handleSetInLineAlert:v});if(m)return r("div",{children:r(le,{})});if(!L.length)return r("div",{});const _={products:r(G,{itemsEligibleForReturn:y,slots:o,translations:C,loading:m,taxConfig:g,selectedProductList:e,handleSelectedProductList:u,showConfigurableOptions:R,handleSetQuantity:x,handleChangeStep:E}),attributes:r(ke,{slots:o,formsRef:O,loading:m,fieldsConfig:L,selectedProductList:e,handleChangeStep:E,translations:C,onSubmit:d}),success:r(be,{translations:C,routeReturnSuccess:p}),error:null};return A("div",{className:V(["order-create-return",s]),children:[r(Z,{title:C.headerText}),w.heading?r(U,{className:"order-create-return_notification",variant:"secondary","data-testid":"orderCreateReturnNotification",...w}):null,_[t]]})};export{Qe as CreateReturn,Qe as default};
