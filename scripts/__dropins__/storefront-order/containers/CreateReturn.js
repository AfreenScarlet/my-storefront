import{jsx as s,jsxs as w}from"@dropins/tools/preact-jsx-runtime.js";import{classes as B,Slot as H}from"@dropins/tools/lib.js";import{Checkbox as U,Button as Q,CartItem as Z,Image as D,Header as J,InLineAlert as z}from"@dropins/tools/components.js";import{u as K,a as G}from"../chunks/OrderCancel.js";import{useState as v,useCallback as x,useRef as X,useEffect as $}from"@dropins/tools/preact-hooks.js";import{events as Y}from"@dropins/tools/event-bus.js";import*as O from"@dropins/tools/preact-compat.js";import{S as I,C as ee,a as te}from"../chunks/CartSummaryItem.js";import{O as ne}from"../chunks/OrderLoaders.js";import{Fragment as re,createRef as se}from"@dropins/tools/preact.js";import{r as ae,m as ie,c as ce,n as oe}from"../chunks/returnOrdersHelper.js";import{g as ue}from"../chunks/getFormValues.js";import{s as le}from"../chunks/setTaxStatus.js";import{g as de,r as pe}from"../chunks/requestReturn.js";import{g as me}from"../chunks/getStoreConfig.js";import{useText as he}from"@dropins/tools/i18n.js";import"../chunks/form.types.js";import"../chunks/network-error.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/transform-attributes-form.js";import"../chunks/convertCase.js";const ge=n=>O.createElement("svg",{id:"Icon_Warning_Base",width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...n},O.createElement("g",{clipPath:"url(#clip0_841_1324)"},O.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M11.9949 2.30237L0.802734 21.6977H23.1977L11.9949 2.30237Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"}),O.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M12.4336 10.5504L12.3373 14.4766H11.6632L11.5669 10.5504V9.51273H12.4336V10.5504ZM11.5883 18.2636V17.2687H12.4229V18.2636H11.5883Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"})),O.createElement("defs",null,O.createElement("clipPath",{id:"clip0_841_1324"},O.createElement("rect",{width:24,height:21,fill:"white",transform:"translate(0 1.5)"})))),fe=n=>O.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...n},O.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M0.75 12C0.75 5.78421 5.78421 0.75 12 0.75C18.2158 0.75 23.25 5.78421 23.25 12C23.25 18.2158 18.2158 23.25 12 23.25C5.78421 23.25 0.75 18.2158 0.75 12Z",stroke:"currentColor"}),O.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M6.75 12.762L10.2385 15.75L17.25 9",stroke:"currentColor"})),be={success:s(fe,{}),warning:s(ge,{}),error:s(I,{})},Se=()=>{const[n,a]=v({type:"success",heading:""}),c=x(d=>{if(!(d!=null&&d.type)){a({type:"success",heading:""});return}const h=be[d.type];a({...d,icon:h})},[]);return{inLineAlertProps:n,handleSetInLineAlert:c}},ke=({itemsEligibleForReturn:n,slots:a,loading:c=!1,taxConfig:d,translations:h={},selectedProductList:u,handleSelectedProductList:f,showConfigurableOptions:b,handleSetQuantity:_,moveToAttributesStep:L})=>(console.log("itemsEligibleForReturn",n),console.log("taxConfig",d),console.log("translations",h),console.log("selectedProductList",u),w("ul",{className:"order-return-order-product-list",children:[n==null?void 0:n.map((o,y)=>{const p=`${y+1}_${o.id}`,S=u.some(t=>(t==null?void 0:t.productSku)===o.productSku&&o.eligibleForReturn&&o.quantityReturned===0);return w("li",{"data-testid":p,className:B(["order-return-order-product-list__item",["order-return-order-product-list__item--blur",!o.eligibleForReturn]]),children:[s(U,{name:p,checked:S,disabled:!o.eligibleForReturn||o.quantityReturned!==0,onChange:()=>{f({...o,currentReturnOrderQuantity:1})}}),s(ee,{loading:c,product:o,itemType:"",taxConfig:d,translations:h,showConfigurableOptions:b,disabledIncrementer:!S,isReturnProductList:!0,onQuantity:(o==null?void 0:o.returnableQuantity)>1?t=>_(t,o.productSku):void 0}),a!=null&&a.ReturnOrderItem?s(H,{"data-testid":"returnOrderItem",name:"ReturnOrderItem",slot:a==null?void 0:a.ReturnOrderItem,context:{}}):null]},p)}),s("li",{className:"order-return-order-product-list__item",children:s(Q,{type:"button",onClick:L,disabled:!u.length,children:h.nextStep})})]})),Re=({routeReturnSuccess:n,translations:a})=>{const c=()=>{window.location.href=(n==null?void 0:n())??""};return w("div",{className:"order-return-order-message",children:[s("p",{className:"order-return-order-message__title",children:a.successTitle}),s("p",{className:"order-return-order-message__subtitle",children:a.successMessage}),s(Q,{onClick:c,type:"button",children:a.backStore})]})},Oe=({slots:n,formsRef:a,selectedProductList:c,loading:d,fieldsConfig:h,translations:u,handleChangeStep:f,onSubmit:b})=>{const{formData:_,errors:L,formRef:o,handleChange:y,handleBlur:p,handleSubmit:S}=K({fieldsConfig:ae(h,c==null?void 0:c.length),onSubmit:b});return w("form",{className:"order-return-reason-form",ref:o,onSubmit:S,name:"returnReasonForm",children:[c.map((t,k)=>{var R,F,P,M,r;const e=(t==null?void 0:t.giftCard)||{},m=t==null?void 0:t.product,T=ie(h,k),E=`${t==null?void 0:t.id}_${k}`,g=(t==null?void 0:t.currentReturnOrderQuantity)??1,A={..."configurableOptions"in t?t.configurableOptions:{},..."bundleOptions"in t?t.bundleOptions:{},..."senderName"in e&&(e!=null&&e.senderName)?{[u.sender]:e==null?void 0:e.senderName}:{},..."senderEmail"in e&&(e!=null&&e.senderEmail)?{[u.sender]:e==null?void 0:e.senderEmail}:{},..."recipientName"in e&&(e!=null&&e.recipientName)?{[u.recipient]:e==null?void 0:e.recipientName}:{},..."recipientEmail"in e&&(e!=null&&e.recipientEmail)?{[u.recipient]:e==null?void 0:e.recipientEmail}:{},..."message"in e&&(e!=null&&e.message)?{[u.message]:e==null?void 0:e.message}:{},..."downloadableLinks"in t&&(t!=null&&t.downloadableLinks)?{[`${(R=t==null?void 0:t.downloadableLinks)==null?void 0:R.count} ${u.downloadableCount}`]:(F=t==null?void 0:t.downloadableLinks)==null?void 0:F.result}:{}};return w(re,{children:[s(Z,{loading:d,title:s("div",{"data-testid":"product-name",children:(P=t==null?void 0:t.product)==null?void 0:P.name}),sku:s("div",{children:m==null?void 0:m.sku}),quantity:g,onQuantity:void 0,image:s(D,{src:((M=m==null?void 0:m.thumbnail)==null?void 0:M.url)??"",alt:((r=m==null?void 0:m.thumbnail)==null?void 0:r.label)??"",loading:"lazy",width:"90",height:"120"}),configurations:A}),s("form",{name:E,ref:a==null?void 0:a.current[k],"data-quantity":g,children:s(G,{className:"className",loading:d,fields:T,onChange:y,onBlur:p,errors:L,values:_})})]},k)}),n!=null&&n.ReturnFormActions?s(H,{"data-testid":"returnFormActions",name:"ReturnFormActions",slot:n==null?void 0:n.ReturnFormActions,context:{handleChangeStep:f}}):w("div",{className:"order-return-reason-form__actions",children:[s(Q,{variant:"secondary",type:"button",onClick:()=>{f("products")},children:u.backStep}),s(Q,{children:u.submit})]})]})},q="returnOrdersStepSession",ye=({onSuccess:n,onError:a,handleSetInLineAlert:c,orderData:d})=>{const[h,u]=v(d),[f,b]=v({orderUid:"",contactEmail:""}),[_,L]=v("products"),[o,y]=v(!0),[p,S]=v(JSON.parse(sessionStorage.getItem(q))??[]),[t,k]=v([]),[e,m]=v({taxIncluded:!1,taxExcluded:!1}),[T,E]=v([]),g=X([]);g.current.length!==p.length&&(g.current=p.map((r,l)=>g.current[l]||se())),$(()=>{const r=Y.on("order/data",l=>{u(l),E(te(l)),b({orderUid:l.id??"",contactEmail:(l==null?void 0:l.email)??""}),y(!1)},{eager:!0});return()=>{r==null||r.off()}},[]),$(()=>{me().then(r=>{r&&m(le(r==null?void 0:r.shoppingCartDisplayPrice))})},[]),$(()=>{de("RMA_ITEM").then(r=>{r.length&&k(r)})},[]);const A=x(r=>{S(l=>{const i=l.some(C=>(C==null?void 0:C.productSku)===(r==null?void 0:r.productSku))?l.filter(C=>(C==null?void 0:C.productSku)!==(r==null?void 0:r.productSku)):[...l,r];return sessionStorage.setItem(q,JSON.stringify(i)),i})},[]),R=x(r=>{L(r),c()},[c]),F=x(()=>{p.length&&R("attributes")},[R,p.length]),P=x((r,l)=>{const N=p.map(i=>i.productSku===l?{...i,currentReturnOrderQuantity:r}:i);S(N),sessionStorage.setItem(q,JSON.stringify(N))},[p]),M=x(async(r,l)=>{if(!l)return null;y(!0);const N=[];g.current.length&&g.current.forEach(({current:i})=>{var j;const C=i==null?void 0:i.name.replace(/_\d+$/,""),V=((j=i==null?void 0:i.dataset)==null?void 0:j.quantity)??1,W=ce(ue(i));N.push({orderItemUid:C,quantityToReturn:+V,...oe(W)})}),pe({...f,items:N}).then(i=>{i&&(n==null||n(i),sessionStorage.removeItem(q),R("success"),c())}).catch(i=>{a==null||a(i.message),c({type:"error",heading:i.message})}),y(!1)},[R,a,n,c,f]);return{order:h,steps:_,loading:o,formsRef:g,taxConfig:e,orderReturnInfo:f,attributesList:t,selectedProductList:p,itemsEligibleForReturn:T,handleSelectedProductList:A,moveToAttributesStep:F,handleSetQuantity:P,handleChangeStep:R,onSubmit:M}},Ue=({className:n,orderData:a,slots:c,onSuccess:d,onError:h,routeReturnSuccess:u,showConfigurableOptions:f})=>{const b=he({headerText:"Order.CreateReturn.headerText",successTitle:"Order.CreateReturn.success.title",successMessage:"Order.CreateReturn.success.message",sender:"Order.CreateReturn.giftCard.sender",recipient:"Order.CreateReturn.giftCard.recipient",message:"Order.CreateReturn.giftCard.message",outOfStock:"Order.CreateReturn.stockStatus.outOfStock",nextStep:"Order.CreateReturn.buttons.nextStep",backStep:"Order.CreateReturn.buttons.backStep",submit:"Order.CreateReturn.buttons.submit",backStore:"Order.CreateReturn.buttons.backStore",downloadableCount:"Order.CreateReturn.downloadableCount",returnedItems:"Order.CreateReturn.returnedItems"}),{inLineAlertProps:_,handleSetInLineAlert:L}=Se(),{itemsEligibleForReturn:o,formsRef:y,taxConfig:p,attributesList:S,steps:t,loading:k,selectedProductList:e,handleSelectedProductList:m,handleSetQuantity:T,handleChangeStep:E,onSubmit:g,moveToAttributesStep:A}=ye({orderData:a,onSuccess:d,onError:h,handleSetInLineAlert:L});if(k)return s("div",{children:s(ne,{})});if(!S.length)return s("div",{});const R={products:s(ke,{itemsEligibleForReturn:o,slots:c,translations:b,loading:k,taxConfig:p,selectedProductList:e,handleSelectedProductList:m,showConfigurableOptions:f,handleSetQuantity:T,handleChangeStep:E,moveToAttributesStep:A}),attributes:s(Oe,{slots:c,formsRef:y,loading:k,fieldsConfig:S,selectedProductList:e,handleChangeStep:E,translations:b,onSubmit:g}),success:s(Re,{translations:b,routeReturnSuccess:u}),error:null};return w("div",{className:B(["order-create-return",n]),children:[s(J,{title:b.headerText}),_.heading?s(z,{className:"order-create-return_notification",variant:"secondary","data-testid":"orderCreateReturnNotification",..._}):null,R[t]]})};export{Ue as CreateReturn,Ue as default};
