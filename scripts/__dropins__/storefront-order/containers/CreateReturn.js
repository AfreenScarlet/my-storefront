/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as r,jsxs as N}from"@dropins/tools/preact-jsx-runtime.js";import{classes as q,Slot as B}from"@dropins/tools/lib.js";import{Icon as H,Header as $,InLineAlert as W,Button as T,Checkbox as j,CartItem as V,Image as Z}from"@dropins/tools/components.js";import{useState as _,useRef as D,useEffect as P,useCallback as M}from"@dropins/tools/preact-hooks.js";import{u as U,a as z}from"../chunks/ShippingStatusCard.js";import*as S from"@dropins/tools/preact-compat.js";import{s as G}from"../chunks/setTaxStatus.js";import{createRef as J,Fragment as K}from"@dropins/tools/preact.js";import{s as X,p as Y,r as I,m as ee}from"../chunks/returnOrdersHelper.js";import{events as te}from"@dropins/tools/event-bus.js";import{g as ne,r as re}from"../chunks/requestReturn.js";import{g as ae}from"../chunks/getStoreConfig.js";import{S as se,C as ce}from"../chunks/CartSummaryItem.js";import{a as ie}from"../chunks/OrderLoaders.js";import{useText as ue}from"@dropins/tools/i18n.js";import"../chunks/getFormValues.js";import"../chunks/network-error.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/transform-attributes-form.js";import"../chunks/convertCase.js";const oe=s=>S.createElement("svg",{id:"Icon_Warning_Base",width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},S.createElement("g",{clipPath:"url(#clip0_841_1324)"},S.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M11.9949 2.30237L0.802734 21.6977H23.1977L11.9949 2.30237Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"}),S.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M12.4336 10.5504L12.3373 14.4766H11.6632L11.5669 10.5504V9.51273H12.4336V10.5504ZM11.5883 18.2636V17.2687H12.4229V18.2636H11.5883Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"})),S.createElement("defs",null,S.createElement("clipPath",{id:"clip0_841_1324"},S.createElement("rect",{width:24,height:21,fill:"white",transform:"translate(0 1.5)"})))),le=s=>S.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},S.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M0.75 12C0.75 5.78421 5.78421 0.75 12 0.75C18.2158 0.75 23.25 5.78421 23.25 12C23.25 18.2158 18.2158 23.25 12 23.25C5.78421 23.25 0.75 18.2158 0.75 12Z",stroke:"currentColor"}),S.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M6.75 12.762L10.2385 15.75L17.25 9",stroke:"currentColor"})),de=({onSuccess:s,onError:a,handleSetInLineAlert:c,orderData:l})=>{const[m,O]=_({id:"",email:"",...l}),[d,f]=_("products"),[v,k]=_(!0),[i,h]=_([]),[x,C]=_([]),[R,t]=_({taxIncluded:!1,taxExcluded:!1}),[g,e]=_([]),[u,b]=_(""),y=D([]);y.current.length!==i.length&&(y.current=i.map((n,o)=>y.current[o]||J())),P(()=>{const n=te.on("order/data",o=>{O(o);const L=X(o);e(L),k(!1)},{eager:!0});return()=>{n==null||n.off()}},[]),P(()=>{ae().then(n=>{if(!n)return;const o=G(n==null?void 0:n.shoppingCartDisplayPrice);t(o),b(n.baseMediaUrl)})},[]),P(()=>{ne("RMA_ITEM").then(n=>{n!=null&&n.length&&(C(n),k(!1))})},[]);const F=M(n=>{h(o=>o.findIndex(p=>(p==null?void 0:p.productSku)===(n==null?void 0:n.productSku))>-1?o.filter(p=>(p==null?void 0:p.productSku)!==(n==null?void 0:n.productSku)):[...o,n])},[]),w=M(n=>{f(n),c(),n==="products"&&h([])},[c]),A=M((n,o)=>{const L=i.map(p=>p.productSku===o?{...p,currentReturnOrderQuantity:n}:p);h(L)},[i]),Q=M(async(n,o)=>{if(!o)return;k(!0);const L={orderUid:m.id,contactEmail:m.email},p=Y(y);re({...L,items:p}).then(E=>{s==null||s(E),w("success"),c()}).catch(E=>{a==null||a(E.message),c({type:"error",heading:E.message})}),k(!1)},[w,a,s,c,m]);return{order:{...m,placeholderImage:u},steps:d,loading:v,formsRef:y,taxConfig:R,attributesList:x,selectedProductList:i,itemsEligibleForReturn:g,handleSelectedProductList:F,handleSetQuantity:A,handleChangeStep:w,onSubmit:Q}},pe={success:le,warning:oe,error:se},he=()=>{const[s,a]=_({type:"success",heading:""}),c=M(l=>{if(!(l!=null&&l.type)){a({type:"success",heading:""});return}const m=r(H,{source:pe[l.type]});a({...l,icon:m})},[]);return{inLineAlertProps:s,handleSetInLineAlert:c}},qe=({className:s,orderData:a,slots:c,onSuccess:l,onError:m,routeReturnSuccess:O,showConfigurableOptions:d})=>{const f=ue({headerText:"Order.CreateReturn.headerText",successTitle:"Order.CreateReturn.success.title",successMessage:"Order.CreateReturn.success.message",sender:"Order.CreateReturn.giftCard.sender",recipient:"Order.CreateReturn.giftCard.recipient",message:"Order.CreateReturn.giftCard.message",outOfStock:"Order.CreateReturn.stockStatus.outOfStock",nextStep:"Order.CreateReturn.buttons.nextStep",backStep:"Order.CreateReturn.buttons.backStep",submit:"Order.CreateReturn.buttons.submit",backStore:"Order.CreateReturn.buttons.backStore",downloadableCount:"Order.CreateReturn.downloadableCount",returnedItems:"Order.CreateReturn.returnedItems",configurationsListQuantity:"Order.CreateReturn.configurationsList.quantity"}),{inLineAlertProps:v,handleSetInLineAlert:k}=he(),{order:i,itemsEligibleForReturn:h,formsRef:x,taxConfig:C,attributesList:R,steps:t,loading:g,selectedProductList:e,handleSelectedProductList:u,handleSetQuantity:b,handleChangeStep:y,onSubmit:F}=de({orderData:a,onSuccess:l,onError:m,handleSetInLineAlert:k});if(g)return r("div",{children:r(ie,{})});if(!g&&!R.length)return r("div",{});const w={products:r(ge,{itemsEligibleForReturn:h,placeholderImage:i==null?void 0:i.placeholderImage,slots:c,translations:f,loading:g,taxConfig:C,selectedProductList:e,handleSelectedProductList:u,showConfigurableOptions:d,handleSetQuantity:b,handleChangeStep:y}),attributes:r(fe,{placeholderImage:i==null?void 0:i.placeholderImage,slots:c,formsRef:x,loading:g,fieldsConfig:R,selectedProductList:e,handleChangeStep:y,translations:f,onSubmit:F}),success:r(me,{translations:f,routeReturnSuccess:O,orderData:i}),error:null};return N("div",{className:q(["order-create-return",s]),children:[r($,{title:f.headerText}),v.heading?r(W,{className:"order-create-return_notification",variant:"secondary","data-testid":"orderCreateReturnNotification",...v}):null,w[t]]})},me=({routeReturnSuccess:s,translations:a,orderData:c})=>N("div",{className:"order-return-order-message",children:[r("p",{className:"order-return-order-message__title",children:a.successTitle}),r("p",{className:"order-return-order-message__subtitle",children:a.successMessage}),r(T,{href:(s==null?void 0:s(c))??"#",children:a.backStore})]}),ge=({placeholderImage:s,itemsEligibleForReturn:a,slots:c,loading:l,taxConfig:m,translations:O,selectedProductList:d,handleSelectedProductList:f,showConfigurableOptions:v,handleSetQuantity:k,handleChangeStep:i})=>N("ul",{className:"order-return-order-product-list",children:[a==null?void 0:a.map((h,x)=>{const{quantityReturnRequested:C,quantityShipped:R,eligibleForReturn:t}=h,g=d.some(b=>(b==null?void 0:b.productSku)===h.productSku&&h.eligibleForReturn),e=R===C&&t,u=R-C===0?C:R-C;return N("li",{className:q(["order-return-order-product-list__item",["order-return-order-product-list__item--blur",e]]),children:[r(j,{"data-testid":`key_${x}`,name:`key_${x}`,checked:g,disabled:e,onChange:()=>{f({...h,currentReturnOrderQuantity:1})}}),r(ce,{placeholderImage:s,loading:l,product:{...h,totalQuantity:u},itemType:"",taxConfig:m,translations:O,showConfigurableOptions:v,disabledIncrementer:!g,onQuantity:u>1?b=>{k(b,h.productSku)}:void 0}),r(B,{"data-testid":"returnOrderItem",name:"ReturnOrderItem",slot:c==null?void 0:c.ReturnOrderItem})]},h.id)}),r("li",{className:"order-return-order-product-list__item",children:r(T,{type:"button",onClick:()=>i("attributes"),disabled:!d.length,children:O.nextStep})})]}),fe=({placeholderImage:s,slots:a,formsRef:c,selectedProductList:l,loading:m,fieldsConfig:O,translations:d,handleChangeStep:f,onSubmit:v})=>{const{formData:k,errors:i,formRef:h,handleChange:x,handleBlur:C,handleSubmit:R}=U({fieldsConfig:I(O,l==null?void 0:l.length),onSubmit:v});return N("form",{className:"order-return-reason-form",ref:h,onSubmit:R,name:"returnReasonForm",children:[l.map((t,g)=>{var Q,n,o,L,p,E;const e=t==null?void 0:t.giftCard,u=t==null?void 0:t.product,b=ee(O,g),y=`${t==null?void 0:t.id}_${g}`,F=(t==null?void 0:t.currentReturnOrderQuantity)??1,w={...t!=null&&t.currentReturnOrderQuantity?{[d.configurationsListQuantity]:F}:{},...t.configurableOptions||{},...t.bundleOptions||{},...e!=null&&e.senderName?{[d.sender]:e==null?void 0:e.senderName}:{},...e!=null&&e.senderEmail?{[d.sender]:e==null?void 0:e.senderEmail}:{},...e!=null&&e.recipientName?{[d.recipient]:e==null?void 0:e.recipientName}:{},...e!=null&&e.recipientEmail?{[d.recipient]:e==null?void 0:e.recipientEmail}:{},...e!=null&&e.message?{[d.message]:e==null?void 0:e.message}:{},...t!=null&&t.downloadableLinks?{[`${(Q=t==null?void 0:t.downloadableLinks)==null?void 0:Q.count} ${d.downloadableCount}`]:(n=t==null?void 0:t.downloadableLinks)==null?void 0:n.result}:{}},A=(L=(o=u==null?void 0:u.thumbnail)==null?void 0:o.url)!=null&&L.length?u.thumbnail.url:s;return N(K,{children:[r(V,{loading:m,title:r("div",{"data-testid":"product-name",children:(p=t==null?void 0:t.product)==null?void 0:p.name}),sku:r("div",{children:u==null?void 0:u.sku}),image:r(Z,{src:A,alt:((E=u==null?void 0:u.thumbnail)==null?void 0:E.label)??"",loading:"lazy",width:"90",height:"120"}),configurations:w}),r("form",{name:y,ref:c==null?void 0:c.current[g],"data-quantity":F,children:r(z,{className:"className",loading:m,fields:b,onChange:x,onBlur:C,errors:i,values:k})})]},t.id)}),r(B,{"data-testid":"returnFormActions",name:"ReturnFormActions",slot:a==null?void 0:a.ReturnFormActions,context:{handleChangeStep:f},children:N("div",{className:"order-return-reason-form__actions",children:[r(T,{variant:"secondary",type:"button",onClick:()=>{f("products")},children:d.backStep}),r(T,{children:d.submit})]})})]})};export{qe as CreateReturn,qe as default};
